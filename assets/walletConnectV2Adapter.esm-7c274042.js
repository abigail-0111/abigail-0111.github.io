import{ag as Er,ah as _r,O as We,R as ze,U as qt,ai as xr,aj as Sr,ak as Ir,al as Rr,am as Pr,an as Nr,T as st,x as Je,aR as Tr,aS as Ns,_ as Be,Q as It,N as Or,P as Cr,a as Xt,ar as Qe,j as Ar,av as Xe,V as Fr,aT as Oi}from"./provider-browser-5807d46b.js";import{r as ht,a as A,b as Dr,w as Ts,d as Os,f as mi,t as Bt,e as Lr,h as at,D as qr,k as $r,N as S,j as Mr,i as ui,l as zr,V as kr,R as Ur,F as Ci,K as Vr,x as jr,L as Kr,m as Ai,$ as Hr,p as Br,n as Mt,Z as Fi,J as Gr,X as Wr,o as Cs,q as je,s as Jr,u as Yr,v as mt,y as ie,U as Ae,z as ot,A as Le,B as Qr,C as wt,G as As,H as Xr,I as Zr,M as en,O as Fs,P as tn,Q as Ds,S as Ls,T as Et,W as di,Y as Kt,a0 as qs,a1 as sn,a2 as Zt,a3 as rn,a4 as nn,a5 as on,a6 as Vt,a7 as an,a8 as cn,a9 as ei,aa as Di,ab as hn,ac as ln,ad as un,ae as Li,af as dn,ag as pn,ah as gn,ai as fn,aj as yn,ak as mn,al as wn,am as qi}from"./ethereumProvider.esm-dfa3c94a.js";import{l as bn}from"./index-c463d612.js";class vn extends Er{async init(e){this.chainConfig||(this.chainConfig=_r(We.EIP155,1))}async authenticateUser(){if(!this.provider||this.status!==ze.CONNECTED)throw qt.notConnectedError();const{chainNamespace:e,chainId:t}=this.chainConfig,i=await this.provider.request({method:"eth_accounts"});if(i&&i.length>0){const s=xr(i[0],this.name);if(s&&!Sr(s))return{idToken:s};const o={domain:window.location.origin,uri:window.location.href,address:i[0],chainId:parseInt(t,16),version:"1",nonce:Math.random().toString(36).slice(2),issuedAt:new Date().toISOString()},a=await Ir(o,e),c=await this.provider.request({method:"personal_sign",params:[a,i[0]]}),h=await Rr(e,c,a,this.name,this.sessionTime,this.clientId,this.web3AuthNetwork);return Pr(i[0],this.name,h),{idToken:h}}throw qt.notConnectedError("Not connected with wallet, Please login/connect first")}async disconnectSession(){super.checkDisconnectionRequirements();const e=await this.provider.request({method:"eth_accounts"});e&&e.length>0&&Nr(e[0],this.name)}async disconnect(){this.rehydrated=!1,this.emit(st.DISCONNECTED)}}var Gt={},zt={};Object.defineProperty(zt,"__esModule",{value:!0});function En(n){if(typeof n!="string")throw new Error(`Cannot safe json parse value of type ${typeof n}`);try{return JSON.parse(n)}catch{return n}}zt.safeJsonParse=En;function _n(n){return typeof n=="string"?n:JSON.stringify(n,(e,t)=>typeof t>"u"?null:t)}zt.safeJsonStringify=_n;var Rt={exports:{}},$i;function xn(){return $i||($i=1,function(){let n;function e(){}n=e,n.prototype.getItem=function(t){return this.hasOwnProperty(t)?String(this[t]):null},n.prototype.setItem=function(t,i){this[t]=String(i)},n.prototype.removeItem=function(t){delete this[t]},n.prototype.clear=function(){const t=this;Object.keys(t).forEach(function(i){t[i]=void 0,delete t[i]})},n.prototype.key=function(t){return t=t||0,Object.keys(this)[t]},n.prototype.__defineGetter__("length",function(){return Object.keys(this).length}),typeof globalThis<"u"&&globalThis.localStorage?Rt.exports=globalThis.localStorage:typeof window<"u"&&window.localStorage?Rt.exports=window.localStorage:Rt.exports=new e}()),Rt.exports}var ti={},Pt={},Mi;function Sn(){if(Mi)return Pt;Mi=1,Object.defineProperty(Pt,"__esModule",{value:!0}),Pt.IKeyValueStorage=void 0;class n{}return Pt.IKeyValueStorage=n,Pt}var Nt={},zi;function In(){if(zi)return Nt;zi=1,Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.parseEntry=void 0;const n=zt;function e(t){var i;return[t[0],n.safeJsonParse((i=t[1])!==null&&i!==void 0?i:"")]}return Nt.parseEntry=e,Nt}var ki;function Rn(){return ki||(ki=1,function(n){Object.defineProperty(n,"__esModule",{value:!0});const e=ht;e.__exportStar(Sn(),n),e.__exportStar(In(),n)}(ti)),ti}Object.defineProperty(Gt,"__esModule",{value:!0});Gt.KeyValueStorage=void 0;const bt=ht,Ui=zt,Pn=bt.__importDefault(xn()),Nn=Rn();class $s{constructor(){this.localStorage=Pn.default}getKeys(){return bt.__awaiter(this,void 0,void 0,function*(){return Object.keys(this.localStorage)})}getEntries(){return bt.__awaiter(this,void 0,void 0,function*(){return Object.entries(this.localStorage).map(Nn.parseEntry)})}getItem(e){return bt.__awaiter(this,void 0,void 0,function*(){const t=this.localStorage.getItem(e);if(t!==null)return Ui.safeJsonParse(t)})}setItem(e,t){return bt.__awaiter(this,void 0,void 0,function*(){this.localStorage.setItem(e,Ui.safeJsonStringify(t))})}removeItem(e){return bt.__awaiter(this,void 0,void 0,function*(){this.localStorage.removeItem(e)})}}Gt.KeyValueStorage=$s;var Tn=Gt.default=$s,xt={},Tt={},ii={},Ot={};let pt=class{};const On=Object.freeze(Object.defineProperty({__proto__:null,IEvents:pt},Symbol.toStringTag,{value:"Module"})),Cn=bn(On);var Vi;function An(){if(Vi)return Ot;Vi=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.IHeartBeat=void 0;const n=Cn;class e extends n.IEvents{constructor(i){super()}}return Ot.IHeartBeat=e,Ot}var ji;function Ms(){return ji||(ji=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),ht.__exportStar(An(),n)}(ii)),ii}var si={},ut={},Ki;function Fn(){if(Ki)return ut;Ki=1,Object.defineProperty(ut,"__esModule",{value:!0}),ut.HEARTBEAT_EVENTS=ut.HEARTBEAT_INTERVAL=void 0;const n=A;return ut.HEARTBEAT_INTERVAL=n.FIVE_SECONDS,ut.HEARTBEAT_EVENTS={pulse:"heartbeat_pulse"},ut}var Hi;function zs(){return Hi||(Hi=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),ht.__exportStar(Fn(),n)}(si)),si}var Bi;function Dn(){if(Bi)return Tt;Bi=1,Object.defineProperty(Tt,"__esModule",{value:!0}),Tt.HeartBeat=void 0;const n=ht,e=Je,t=A,i=Ms(),s=zs();class o extends i.IHeartBeat{constructor(c){super(c),this.events=new e.EventEmitter,this.interval=s.HEARTBEAT_INTERVAL,this.interval=(c==null?void 0:c.interval)||s.HEARTBEAT_INTERVAL}static init(c){return n.__awaiter(this,void 0,void 0,function*(){const h=new o(c);return yield h.init(),h})}init(){return n.__awaiter(this,void 0,void 0,function*(){yield this.initialize()})}stop(){clearInterval(this.intervalRef)}on(c,h){this.events.on(c,h)}once(c,h){this.events.once(c,h)}off(c,h){this.events.off(c,h)}removeListener(c,h){this.events.removeListener(c,h)}initialize(){return n.__awaiter(this,void 0,void 0,function*(){this.intervalRef=setInterval(()=>this.pulse(),t.toMiliseconds(this.interval))})}pulse(){this.events.emit(s.HEARTBEAT_EVENTS.pulse)}}return Tt.HeartBeat=o,Tt}(function(n){Object.defineProperty(n,"__esModule",{value:!0});const e=ht;e.__exportStar(Dn(),n),e.__exportStar(Ms(),n),e.__exportStar(zs(),n)})(xt);var M={},ri,Gi;function Ln(){if(Gi)return ri;Gi=1;function n(t){try{return JSON.stringify(t)}catch{return'"[Circular]"'}}ri=e;function e(t,i,s){var o=s&&s.stringify||n,a=1;if(typeof t=="object"&&t!==null){var c=i.length+a;if(c===1)return t;var h=new Array(c);h[0]=o(t);for(var d=1;d<c;d++)h[d]=o(i[d]);return h.join(" ")}if(typeof t!="string")return t;var w=i.length;if(w===0)return t;for(var x="",I=1-a,T=-1,E=t&&t.length||0,R=0;R<E;){if(t.charCodeAt(R)===37&&R+1<E){switch(T=T>-1?T:0,t.charCodeAt(R+1)){case 100:case 102:if(I>=w||i[I]==null)break;T<R&&(x+=t.slice(T,R)),x+=Number(i[I]),T=R+2,R++;break;case 105:if(I>=w||i[I]==null)break;T<R&&(x+=t.slice(T,R)),x+=Math.floor(Number(i[I])),T=R+2,R++;break;case 79:case 111:case 106:if(I>=w||i[I]===void 0)break;T<R&&(x+=t.slice(T,R));var $=typeof i[I];if($==="string"){x+="'"+i[I]+"'",T=R+2,R++;break}if($==="function"){x+=i[I].name||"<anonymous>",T=R+2,R++;break}x+=o(i[I]),T=R+2,R++;break;case 115:if(I>=w)break;T<R&&(x+=t.slice(T,R)),x+=String(i[I]),T=R+2,R++;break;case 37:T<R&&(x+=t.slice(T,R)),x+="%",T=R+2,R++,I--;break}++I}++R}return T===-1?t:(T<E&&(x+=t.slice(T)),x)}return ri}var ni,Wi;function qn(){if(Wi)return ni;Wi=1;const n=Ln();ni=s;const e=U().console||{},t={mapHttpRequest:E,mapHttpResponse:E,wrapRequestSerializer:R,wrapResponseSerializer:R,wrapErrorSerializer:R,req:E,res:E,err:I};function i(y,b){return Array.isArray(y)?y.filter(function(L){return L!=="!stdSerializers.err"}):y===!0?Object.keys(b):!1}function s(y){y=y||{},y.browser=y.browser||{};const b=y.browser.transmit;if(b&&typeof b.send!="function")throw Error("pino: transmit option must have a send function");const P=y.browser.write||e;y.browser.write&&(y.browser.asObject=!0);const L=y.serializers||{},F=i(y.browser.serialize,L);let z=y.browser.serialize;Array.isArray(y.browser.serialize)&&y.browser.serialize.indexOf("!stdSerializers.err")>-1&&(z=!1);const H=["error","fatal","warn","info","debug","trace"];typeof P=="function"&&(P.error=P.fatal=P.warn=P.info=P.debug=P.trace=P),y.enabled===!1&&(y.level="silent");const ee=y.level||"info",p=Object.create(P);p.log||(p.log=$),Object.defineProperty(p,"levelVal",{get:G}),Object.defineProperty(p,"level",{get:Q,set:O});const m={transmit:b,serialize:F,asObject:y.browser.asObject,levels:H,timestamp:T(y)};p.levels=s.levels,p.level=ee,p.setMaxListeners=p.getMaxListeners=p.emit=p.addListener=p.on=p.prependListener=p.once=p.prependOnceListener=p.removeListener=p.removeAllListeners=p.listeners=p.listenerCount=p.eventNames=p.write=p.flush=$,p.serializers=L,p._serialize=F,p._stdErrSerialize=z,p.child=_,b&&(p._logEvent=x());function G(){return this.level==="silent"?1/0:this.levels.values[this.level]}function Q(){return this._level}function O(v){if(v!=="silent"&&!this.levels.values[v])throw Error("unknown level "+v);this._level=v,o(m,p,"error","log"),o(m,p,"fatal","error"),o(m,p,"warn","error"),o(m,p,"info","log"),o(m,p,"debug","log"),o(m,p,"trace","log")}function _(v,N){if(!v)throw new Error("missing bindings for child Pino");N=N||{},F&&v.serializers&&(N.serializers=v.serializers);const re=N.serializers;if(F&&re){var Y=Object.assign({},L,re),gt=y.browser.serialize===!0?Object.keys(Y):F;delete v.serializers,h([v],gt,Y,this._stdErrSerialize)}function ft($e){this._childLevel=($e._childLevel|0)+1,this.error=d($e,v,"error"),this.fatal=d($e,v,"fatal"),this.warn=d($e,v,"warn"),this.info=d($e,v,"info"),this.debug=d($e,v,"debug"),this.trace=d($e,v,"trace"),Y&&(this.serializers=Y,this._serialize=gt),b&&(this._logEvent=x([].concat($e._logEvent.bindings,v)))}return ft.prototype=this,new ft(this)}return p}s.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},s.stdSerializers=t,s.stdTimeFunctions=Object.assign({},{nullTime:j,epochTime:k,unixTime:V,isoTime:q});function o(y,b,P,L){const F=Object.getPrototypeOf(b);b[P]=b.levelVal>b.levels.values[P]?$:F[P]?F[P]:e[P]||e[L]||$,a(y,b,P)}function a(y,b,P){!y.transmit&&b[P]===$||(b[P]=function(L){return function(){const z=y.timestamp(),H=new Array(arguments.length),ee=Object.getPrototypeOf&&Object.getPrototypeOf(this)===e?e:this;for(var p=0;p<H.length;p++)H[p]=arguments[p];if(y.serialize&&!y.asObject&&h(H,this._serialize,this.serializers,this._stdErrSerialize),y.asObject?L.call(ee,c(this,P,H,z)):L.apply(ee,H),y.transmit){const m=y.transmit.level||b.level,G=s.levels.values[m],Q=s.levels.values[P];if(Q<G)return;w(this,{ts:z,methodLevel:P,methodValue:Q,transmitLevel:m,transmitValue:s.levels.values[y.transmit.level||b.level],send:y.transmit.send,val:b.levelVal},H)}}}(b[P]))}function c(y,b,P,L){y._serialize&&h(P,y._serialize,y.serializers,y._stdErrSerialize);const F=P.slice();let z=F[0];const H={};L&&(H.time=L),H.level=s.levels.values[b];let ee=(y._childLevel|0)+1;if(ee<1&&(ee=1),z!==null&&typeof z=="object"){for(;ee--&&typeof F[0]=="object";)Object.assign(H,F.shift());z=F.length?n(F.shift(),F):void 0}else typeof z=="string"&&(z=n(F.shift(),F));return z!==void 0&&(H.msg=z),H}function h(y,b,P,L){for(const F in y)if(L&&y[F]instanceof Error)y[F]=s.stdSerializers.err(y[F]);else if(typeof y[F]=="object"&&!Array.isArray(y[F]))for(const z in y[F])b&&b.indexOf(z)>-1&&z in P&&(y[F][z]=P[z](y[F][z]))}function d(y,b,P){return function(){const L=new Array(1+arguments.length);L[0]=b;for(var F=1;F<L.length;F++)L[F]=arguments[F-1];return y[P].apply(this,L)}}function w(y,b,P){const L=b.send,F=b.ts,z=b.methodLevel,H=b.methodValue,ee=b.val,p=y._logEvent.bindings;h(P,y._serialize||Object.keys(y.serializers),y.serializers,y._stdErrSerialize===void 0?!0:y._stdErrSerialize),y._logEvent.ts=F,y._logEvent.messages=P.filter(function(m){return p.indexOf(m)===-1}),y._logEvent.level.label=z,y._logEvent.level.value=H,L(z,y._logEvent,ee),y._logEvent=x(p)}function x(y){return{ts:0,messages:[],bindings:y||[],level:{label:"",value:0}}}function I(y){const b={type:y.constructor.name,msg:y.message,stack:y.stack};for(const P in y)b[P]===void 0&&(b[P]=y[P]);return b}function T(y){return typeof y.timestamp=="function"?y.timestamp:y.timestamp===!1?j:k}function E(){return{}}function R(y){return y}function $(){}function j(){return!1}function k(){return Date.now()}function V(){return Math.round(Date.now()/1e3)}function q(){return new Date(Date.now()).toISOString()}function U(){function y(b){return typeof b<"u"&&b}try{return typeof globalThis<"u"||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch{return y(self)||y(window)||y(this)||{}}}return ni}var dt={},Ji;function ks(){return Ji||(Ji=1,Object.defineProperty(dt,"__esModule",{value:!0}),dt.PINO_CUSTOM_CONTEXT_KEY=dt.PINO_LOGGER_DEFAULTS=void 0,dt.PINO_LOGGER_DEFAULTS={level:"info"},dt.PINO_CUSTOM_CONTEXT_KEY="custom_context"),dt}var Ce={},Yi;function $n(){if(Yi)return Ce;Yi=1,Object.defineProperty(Ce,"__esModule",{value:!0}),Ce.generateChildLogger=Ce.formatChildLoggerContext=Ce.getLoggerContext=Ce.setBrowserLoggerContext=Ce.getBrowserLoggerContext=Ce.getDefaultLoggerOptions=void 0;const n=ks();function e(c){return Object.assign(Object.assign({},c),{level:(c==null?void 0:c.level)||n.PINO_LOGGER_DEFAULTS.level})}Ce.getDefaultLoggerOptions=e;function t(c,h=n.PINO_CUSTOM_CONTEXT_KEY){return c[h]||""}Ce.getBrowserLoggerContext=t;function i(c,h,d=n.PINO_CUSTOM_CONTEXT_KEY){return c[d]=h,c}Ce.setBrowserLoggerContext=i;function s(c,h=n.PINO_CUSTOM_CONTEXT_KEY){let d="";return typeof c.bindings>"u"?d=t(c,h):d=c.bindings().context||"",d}Ce.getLoggerContext=s;function o(c,h,d=n.PINO_CUSTOM_CONTEXT_KEY){const w=s(c,d);return w.trim()?`${w}/${h}`:h}Ce.formatChildLoggerContext=o;function a(c,h,d=n.PINO_CUSTOM_CONTEXT_KEY){const w=o(c,h,d),x=c.child({context:w});return i(x,w,d)}return Ce.generateChildLogger=a,Ce}(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.pino=void 0;const e=ht,t=e.__importDefault(qn());Object.defineProperty(n,"pino",{enumerable:!0,get:function(){return t.default}}),e.__exportStar(ks(),n),e.__exportStar($n(),n)})(M);class Mn extends pt{constructor(e){super(),this.opts=e,this.protocol="wc",this.version=2}}class zn extends pt{constructor(e,t){super(),this.core=e,this.logger=t,this.records=new Map}}class kn{constructor(e,t){this.logger=e,this.core=t}}class Un extends pt{constructor(e,t){super(),this.relayer=e,this.logger=t}}let Vn=class extends pt{constructor(e){super()}};class jn{constructor(e,t,i,s){this.core=e,this.logger=t,this.name=i}}class Kn extends pt{constructor(e,t){super(),this.relayer=e,this.logger=t}}class Hn extends pt{constructor(e,t){super(),this.core=e,this.logger=t}}class Bn{constructor(e,t){this.projectId=e,this.logger=t}}let Gn=class{constructor(e){this.opts=e,this.protocol="wc",this.version=2}};class Wn{constructor(e){this.client=e}}const Jn=n=>JSON.stringify(n,(e,t)=>typeof t=="bigint"?t.toString()+"n":t),Yn=n=>{const e=/([\[:])?(\d{17,}|(?:[9](?:[1-9]07199254740991|0[1-9]7199254740991|00[8-9]199254740991|007[2-9]99254740991|007199[3-9]54740991|0071992[6-9]4740991|00719925[5-9]740991|007199254[8-9]40991|0071992547[5-9]0991|00719925474[1-9]991|00719925474099[2-9])))([,\}\]])/g,t=n.replace(e,'$1"$2n"$3');return JSON.parse(t,(i,s)=>typeof s=="string"&&s.match(/^\d+n$/)?BigInt(s.substring(0,s.length-1)):s)};function Us(n){if(typeof n!="string")throw new Error(`Cannot safe json parse value of type ${typeof n}`);try{return Yn(n)}catch{return n}}function wi(n){return typeof n=="string"?n:Jn(n)||""}var bi={},Vs={};(function(n){Object.defineProperty(n,"__esModule",{value:!0});var e=Dr,t=Ts;n.DIGEST_LENGTH=64,n.BLOCK_SIZE=128;var i=function(){function c(){this.digestLength=n.DIGEST_LENGTH,this.blockSize=n.BLOCK_SIZE,this._stateHi=new Int32Array(8),this._stateLo=new Int32Array(8),this._tempHi=new Int32Array(16),this._tempLo=new Int32Array(16),this._buffer=new Uint8Array(256),this._bufferLength=0,this._bytesHashed=0,this._finished=!1,this.reset()}return c.prototype._initState=function(){this._stateHi[0]=1779033703,this._stateHi[1]=3144134277,this._stateHi[2]=1013904242,this._stateHi[3]=2773480762,this._stateHi[4]=1359893119,this._stateHi[5]=2600822924,this._stateHi[6]=528734635,this._stateHi[7]=1541459225,this._stateLo[0]=4089235720,this._stateLo[1]=2227873595,this._stateLo[2]=4271175723,this._stateLo[3]=1595750129,this._stateLo[4]=2917565137,this._stateLo[5]=725511199,this._stateLo[6]=4215389547,this._stateLo[7]=327033209},c.prototype.reset=function(){return this._initState(),this._bufferLength=0,this._bytesHashed=0,this._finished=!1,this},c.prototype.clean=function(){t.wipe(this._buffer),t.wipe(this._tempHi),t.wipe(this._tempLo),this.reset()},c.prototype.update=function(h,d){if(d===void 0&&(d=h.length),this._finished)throw new Error("SHA512: can't update because hash was finished.");var w=0;if(this._bytesHashed+=d,this._bufferLength>0){for(;this._bufferLength<n.BLOCK_SIZE&&d>0;)this._buffer[this._bufferLength++]=h[w++],d--;this._bufferLength===this.blockSize&&(o(this._tempHi,this._tempLo,this._stateHi,this._stateLo,this._buffer,0,this.blockSize),this._bufferLength=0)}for(d>=this.blockSize&&(w=o(this._tempHi,this._tempLo,this._stateHi,this._stateLo,h,w,d),d%=this.blockSize);d>0;)this._buffer[this._bufferLength++]=h[w++],d--;return this},c.prototype.finish=function(h){if(!this._finished){var d=this._bytesHashed,w=this._bufferLength,x=d/536870912|0,I=d<<3,T=d%128<112?128:256;this._buffer[w]=128;for(var E=w+1;E<T-8;E++)this._buffer[E]=0;e.writeUint32BE(x,this._buffer,T-8),e.writeUint32BE(I,this._buffer,T-4),o(this._tempHi,this._tempLo,this._stateHi,this._stateLo,this._buffer,0,T),this._finished=!0}for(var E=0;E<this.digestLength/8;E++)e.writeUint32BE(this._stateHi[E],h,E*8),e.writeUint32BE(this._stateLo[E],h,E*8+4);return this},c.prototype.digest=function(){var h=new Uint8Array(this.digestLength);return this.finish(h),h},c.prototype.saveState=function(){if(this._finished)throw new Error("SHA256: cannot save finished state");return{stateHi:new Int32Array(this._stateHi),stateLo:new Int32Array(this._stateLo),buffer:this._bufferLength>0?new Uint8Array(this._buffer):void 0,bufferLength:this._bufferLength,bytesHashed:this._bytesHashed}},c.prototype.restoreState=function(h){return this._stateHi.set(h.stateHi),this._stateLo.set(h.stateLo),this._bufferLength=h.bufferLength,h.buffer&&this._buffer.set(h.buffer),this._bytesHashed=h.bytesHashed,this._finished=!1,this},c.prototype.cleanSavedState=function(h){t.wipe(h.stateHi),t.wipe(h.stateLo),h.buffer&&t.wipe(h.buffer),h.bufferLength=0,h.bytesHashed=0},c}();n.SHA512=i;var s=new Int32Array([1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591]);function o(c,h,d,w,x,I,T){for(var E=d[0],R=d[1],$=d[2],j=d[3],k=d[4],V=d[5],q=d[6],U=d[7],y=w[0],b=w[1],P=w[2],L=w[3],F=w[4],z=w[5],H=w[6],ee=w[7],p,m,G,Q,O,_,v,N;T>=128;){for(var re=0;re<16;re++){var Y=8*re+I;c[re]=e.readUint32BE(x,Y),h[re]=e.readUint32BE(x,Y+4)}for(var re=0;re<80;re++){var gt=E,ft=R,$e=$,g=j,f=k,u=V,r=q,l=U,C=y,D=b,B=P,W=L,K=F,J=z,Ne=H,oe=ee;if(p=U,m=ee,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=(k>>>14|F<<32-14)^(k>>>18|F<<32-18)^(F>>>41-32|k<<32-(41-32)),m=(F>>>14|k<<32-14)^(F>>>18|k<<32-18)^(k>>>41-32|F<<32-(41-32)),O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,p=k&V^~k&q,m=F&z^~F&H,O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,p=s[re*2],m=s[re*2+1],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,p=c[re%16],m=h[re%16],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,G=v&65535|N<<16,Q=O&65535|_<<16,p=G,m=Q,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=(E>>>28|y<<32-28)^(y>>>34-32|E<<32-(34-32))^(y>>>39-32|E<<32-(39-32)),m=(y>>>28|E<<32-28)^(E>>>34-32|y<<32-(34-32))^(E>>>39-32|y<<32-(39-32)),O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,p=E&R^E&$^R&$,m=y&b^y&P^b&P,O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,l=v&65535|N<<16,oe=O&65535|_<<16,p=g,m=W,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=G,m=Q,O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,g=v&65535|N<<16,W=O&65535|_<<16,R=gt,$=ft,j=$e,k=g,V=f,q=u,U=r,E=l,b=C,P=D,L=B,F=W,z=K,H=J,ee=Ne,y=oe,re%16===15)for(var Y=0;Y<16;Y++)p=c[Y],m=h[Y],O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=c[(Y+9)%16],m=h[(Y+9)%16],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,G=c[(Y+1)%16],Q=h[(Y+1)%16],p=(G>>>1|Q<<32-1)^(G>>>8|Q<<32-8)^G>>>7,m=(Q>>>1|G<<32-1)^(Q>>>8|G<<32-8)^(Q>>>7|G<<32-7),O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,G=c[(Y+14)%16],Q=h[(Y+14)%16],p=(G>>>19|Q<<32-19)^(Q>>>61-32|G<<32-(61-32))^G>>>6,m=(Q>>>19|G<<32-19)^(G>>>61-32|Q<<32-(61-32))^(Q>>>6|G<<32-6),O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,c[Y]=v&65535|N<<16,h[Y]=O&65535|_<<16}p=E,m=y,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[0],m=w[0],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[0]=E=v&65535|N<<16,w[0]=y=O&65535|_<<16,p=R,m=b,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[1],m=w[1],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[1]=R=v&65535|N<<16,w[1]=b=O&65535|_<<16,p=$,m=P,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[2],m=w[2],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[2]=$=v&65535|N<<16,w[2]=P=O&65535|_<<16,p=j,m=L,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[3],m=w[3],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[3]=j=v&65535|N<<16,w[3]=L=O&65535|_<<16,p=k,m=F,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[4],m=w[4],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[4]=k=v&65535|N<<16,w[4]=F=O&65535|_<<16,p=V,m=z,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[5],m=w[5],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[5]=V=v&65535|N<<16,w[5]=z=O&65535|_<<16,p=q,m=H,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[6],m=w[6],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[6]=q=v&65535|N<<16,w[6]=H=O&65535|_<<16,p=U,m=ee,O=m&65535,_=m>>>16,v=p&65535,N=p>>>16,p=d[7],m=w[7],O+=m&65535,_+=m>>>16,v+=p&65535,N+=p>>>16,_+=O>>>16,v+=_>>>16,N+=v>>>16,d[7]=U=v&65535|N<<16,w[7]=ee=O&65535|_<<16,I+=128,T-=128}return I}function a(c){var h=new i;h.update(c);var d=h.digest();return h.clean(),d}n.hash=a})(Vs);(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.convertSecretKeyToX25519=n.convertPublicKeyToX25519=n.verify=n.sign=n.extractPublicKeyFromSecretKey=n.generateKeyPair=n.generateKeyPairFromSeed=n.SEED_LENGTH=n.SECRET_KEY_LENGTH=n.PUBLIC_KEY_LENGTH=n.SIGNATURE_LENGTH=void 0;const e=Os,t=Vs,i=Ts;n.SIGNATURE_LENGTH=64,n.PUBLIC_KEY_LENGTH=32,n.SECRET_KEY_LENGTH=64,n.SEED_LENGTH=32;function s(g){const f=new Float64Array(16);if(g)for(let u=0;u<g.length;u++)f[u]=g[u];return f}const o=new Uint8Array(32);o[0]=9;const a=s(),c=s([1]),h=s([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),d=s([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),w=s([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),x=s([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),I=s([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function T(g,f){for(let u=0;u<16;u++)g[u]=f[u]|0}function E(g){let f=1;for(let u=0;u<16;u++){let r=g[u]+f+65535;f=Math.floor(r/65536),g[u]=r-f*65536}g[0]+=f-1+37*(f-1)}function R(g,f,u){const r=~(u-1);for(let l=0;l<16;l++){const C=r&(g[l]^f[l]);g[l]^=C,f[l]^=C}}function $(g,f){const u=s(),r=s();for(let l=0;l<16;l++)r[l]=f[l];E(r),E(r),E(r);for(let l=0;l<2;l++){u[0]=r[0]-65517;for(let D=1;D<15;D++)u[D]=r[D]-65535-(u[D-1]>>16&1),u[D-1]&=65535;u[15]=r[15]-32767-(u[14]>>16&1);const C=u[15]>>16&1;u[14]&=65535,R(r,u,1-C)}for(let l=0;l<16;l++)g[2*l]=r[l]&255,g[2*l+1]=r[l]>>8}function j(g,f){let u=0;for(let r=0;r<32;r++)u|=g[r]^f[r];return(1&u-1>>>8)-1}function k(g,f){const u=new Uint8Array(32),r=new Uint8Array(32);return $(u,g),$(r,f),j(u,r)}function V(g){const f=new Uint8Array(32);return $(f,g),f[0]&1}function q(g,f){for(let u=0;u<16;u++)g[u]=f[2*u]+(f[2*u+1]<<8);g[15]&=32767}function U(g,f,u){for(let r=0;r<16;r++)g[r]=f[r]+u[r]}function y(g,f,u){for(let r=0;r<16;r++)g[r]=f[r]-u[r]}function b(g,f,u){let r,l,C=0,D=0,B=0,W=0,K=0,J=0,Ne=0,oe=0,Te=0,he=0,ae=0,ne=0,se=0,te=0,X=0,Z=0,le=0,Oe=0,Fe=0,qe=0,Me=0,Ue=0,He=0,Ye=0,nt=0,lt=0,yt=0,St=0,Ut=0,Qt=0,Ti=0,ue=u[0],de=u[1],pe=u[2],ge=u[3],fe=u[4],ye=u[5],me=u[6],we=u[7],be=u[8],ve=u[9],Ee=u[10],_e=u[11],xe=u[12],Se=u[13],Ie=u[14],Re=u[15];r=f[0],C+=r*ue,D+=r*de,B+=r*pe,W+=r*ge,K+=r*fe,J+=r*ye,Ne+=r*me,oe+=r*we,Te+=r*be,he+=r*ve,ae+=r*Ee,ne+=r*_e,se+=r*xe,te+=r*Se,X+=r*Ie,Z+=r*Re,r=f[1],D+=r*ue,B+=r*de,W+=r*pe,K+=r*ge,J+=r*fe,Ne+=r*ye,oe+=r*me,Te+=r*we,he+=r*be,ae+=r*ve,ne+=r*Ee,se+=r*_e,te+=r*xe,X+=r*Se,Z+=r*Ie,le+=r*Re,r=f[2],B+=r*ue,W+=r*de,K+=r*pe,J+=r*ge,Ne+=r*fe,oe+=r*ye,Te+=r*me,he+=r*we,ae+=r*be,ne+=r*ve,se+=r*Ee,te+=r*_e,X+=r*xe,Z+=r*Se,le+=r*Ie,Oe+=r*Re,r=f[3],W+=r*ue,K+=r*de,J+=r*pe,Ne+=r*ge,oe+=r*fe,Te+=r*ye,he+=r*me,ae+=r*we,ne+=r*be,se+=r*ve,te+=r*Ee,X+=r*_e,Z+=r*xe,le+=r*Se,Oe+=r*Ie,Fe+=r*Re,r=f[4],K+=r*ue,J+=r*de,Ne+=r*pe,oe+=r*ge,Te+=r*fe,he+=r*ye,ae+=r*me,ne+=r*we,se+=r*be,te+=r*ve,X+=r*Ee,Z+=r*_e,le+=r*xe,Oe+=r*Se,Fe+=r*Ie,qe+=r*Re,r=f[5],J+=r*ue,Ne+=r*de,oe+=r*pe,Te+=r*ge,he+=r*fe,ae+=r*ye,ne+=r*me,se+=r*we,te+=r*be,X+=r*ve,Z+=r*Ee,le+=r*_e,Oe+=r*xe,Fe+=r*Se,qe+=r*Ie,Me+=r*Re,r=f[6],Ne+=r*ue,oe+=r*de,Te+=r*pe,he+=r*ge,ae+=r*fe,ne+=r*ye,se+=r*me,te+=r*we,X+=r*be,Z+=r*ve,le+=r*Ee,Oe+=r*_e,Fe+=r*xe,qe+=r*Se,Me+=r*Ie,Ue+=r*Re,r=f[7],oe+=r*ue,Te+=r*de,he+=r*pe,ae+=r*ge,ne+=r*fe,se+=r*ye,te+=r*me,X+=r*we,Z+=r*be,le+=r*ve,Oe+=r*Ee,Fe+=r*_e,qe+=r*xe,Me+=r*Se,Ue+=r*Ie,He+=r*Re,r=f[8],Te+=r*ue,he+=r*de,ae+=r*pe,ne+=r*ge,se+=r*fe,te+=r*ye,X+=r*me,Z+=r*we,le+=r*be,Oe+=r*ve,Fe+=r*Ee,qe+=r*_e,Me+=r*xe,Ue+=r*Se,He+=r*Ie,Ye+=r*Re,r=f[9],he+=r*ue,ae+=r*de,ne+=r*pe,se+=r*ge,te+=r*fe,X+=r*ye,Z+=r*me,le+=r*we,Oe+=r*be,Fe+=r*ve,qe+=r*Ee,Me+=r*_e,Ue+=r*xe,He+=r*Se,Ye+=r*Ie,nt+=r*Re,r=f[10],ae+=r*ue,ne+=r*de,se+=r*pe,te+=r*ge,X+=r*fe,Z+=r*ye,le+=r*me,Oe+=r*we,Fe+=r*be,qe+=r*ve,Me+=r*Ee,Ue+=r*_e,He+=r*xe,Ye+=r*Se,nt+=r*Ie,lt+=r*Re,r=f[11],ne+=r*ue,se+=r*de,te+=r*pe,X+=r*ge,Z+=r*fe,le+=r*ye,Oe+=r*me,Fe+=r*we,qe+=r*be,Me+=r*ve,Ue+=r*Ee,He+=r*_e,Ye+=r*xe,nt+=r*Se,lt+=r*Ie,yt+=r*Re,r=f[12],se+=r*ue,te+=r*de,X+=r*pe,Z+=r*ge,le+=r*fe,Oe+=r*ye,Fe+=r*me,qe+=r*we,Me+=r*be,Ue+=r*ve,He+=r*Ee,Ye+=r*_e,nt+=r*xe,lt+=r*Se,yt+=r*Ie,St+=r*Re,r=f[13],te+=r*ue,X+=r*de,Z+=r*pe,le+=r*ge,Oe+=r*fe,Fe+=r*ye,qe+=r*me,Me+=r*we,Ue+=r*be,He+=r*ve,Ye+=r*Ee,nt+=r*_e,lt+=r*xe,yt+=r*Se,St+=r*Ie,Ut+=r*Re,r=f[14],X+=r*ue,Z+=r*de,le+=r*pe,Oe+=r*ge,Fe+=r*fe,qe+=r*ye,Me+=r*me,Ue+=r*we,He+=r*be,Ye+=r*ve,nt+=r*Ee,lt+=r*_e,yt+=r*xe,St+=r*Se,Ut+=r*Ie,Qt+=r*Re,r=f[15],Z+=r*ue,le+=r*de,Oe+=r*pe,Fe+=r*ge,qe+=r*fe,Me+=r*ye,Ue+=r*me,He+=r*we,Ye+=r*be,nt+=r*ve,lt+=r*Ee,yt+=r*_e,St+=r*xe,Ut+=r*Se,Qt+=r*Ie,Ti+=r*Re,C+=38*le,D+=38*Oe,B+=38*Fe,W+=38*qe,K+=38*Me,J+=38*Ue,Ne+=38*He,oe+=38*Ye,Te+=38*nt,he+=38*lt,ae+=38*yt,ne+=38*St,se+=38*Ut,te+=38*Qt,X+=38*Ti,l=1,r=C+l+65535,l=Math.floor(r/65536),C=r-l*65536,r=D+l+65535,l=Math.floor(r/65536),D=r-l*65536,r=B+l+65535,l=Math.floor(r/65536),B=r-l*65536,r=W+l+65535,l=Math.floor(r/65536),W=r-l*65536,r=K+l+65535,l=Math.floor(r/65536),K=r-l*65536,r=J+l+65535,l=Math.floor(r/65536),J=r-l*65536,r=Ne+l+65535,l=Math.floor(r/65536),Ne=r-l*65536,r=oe+l+65535,l=Math.floor(r/65536),oe=r-l*65536,r=Te+l+65535,l=Math.floor(r/65536),Te=r-l*65536,r=he+l+65535,l=Math.floor(r/65536),he=r-l*65536,r=ae+l+65535,l=Math.floor(r/65536),ae=r-l*65536,r=ne+l+65535,l=Math.floor(r/65536),ne=r-l*65536,r=se+l+65535,l=Math.floor(r/65536),se=r-l*65536,r=te+l+65535,l=Math.floor(r/65536),te=r-l*65536,r=X+l+65535,l=Math.floor(r/65536),X=r-l*65536,r=Z+l+65535,l=Math.floor(r/65536),Z=r-l*65536,C+=l-1+37*(l-1),l=1,r=C+l+65535,l=Math.floor(r/65536),C=r-l*65536,r=D+l+65535,l=Math.floor(r/65536),D=r-l*65536,r=B+l+65535,l=Math.floor(r/65536),B=r-l*65536,r=W+l+65535,l=Math.floor(r/65536),W=r-l*65536,r=K+l+65535,l=Math.floor(r/65536),K=r-l*65536,r=J+l+65535,l=Math.floor(r/65536),J=r-l*65536,r=Ne+l+65535,l=Math.floor(r/65536),Ne=r-l*65536,r=oe+l+65535,l=Math.floor(r/65536),oe=r-l*65536,r=Te+l+65535,l=Math.floor(r/65536),Te=r-l*65536,r=he+l+65535,l=Math.floor(r/65536),he=r-l*65536,r=ae+l+65535,l=Math.floor(r/65536),ae=r-l*65536,r=ne+l+65535,l=Math.floor(r/65536),ne=r-l*65536,r=se+l+65535,l=Math.floor(r/65536),se=r-l*65536,r=te+l+65535,l=Math.floor(r/65536),te=r-l*65536,r=X+l+65535,l=Math.floor(r/65536),X=r-l*65536,r=Z+l+65535,l=Math.floor(r/65536),Z=r-l*65536,C+=l-1+37*(l-1),g[0]=C,g[1]=D,g[2]=B,g[3]=W,g[4]=K,g[5]=J,g[6]=Ne,g[7]=oe,g[8]=Te,g[9]=he,g[10]=ae,g[11]=ne,g[12]=se,g[13]=te,g[14]=X,g[15]=Z}function P(g,f){b(g,f,f)}function L(g,f){const u=s();let r;for(r=0;r<16;r++)u[r]=f[r];for(r=253;r>=0;r--)P(u,u),r!==2&&r!==4&&b(u,u,f);for(r=0;r<16;r++)g[r]=u[r]}function F(g,f){const u=s();let r;for(r=0;r<16;r++)u[r]=f[r];for(r=250;r>=0;r--)P(u,u),r!==1&&b(u,u,f);for(r=0;r<16;r++)g[r]=u[r]}function z(g,f){const u=s(),r=s(),l=s(),C=s(),D=s(),B=s(),W=s(),K=s(),J=s();y(u,g[1],g[0]),y(J,f[1],f[0]),b(u,u,J),U(r,g[0],g[1]),U(J,f[0],f[1]),b(r,r,J),b(l,g[3],f[3]),b(l,l,d),b(C,g[2],f[2]),U(C,C,C),y(D,r,u),y(B,C,l),U(W,C,l),U(K,r,u),b(g[0],D,B),b(g[1],K,W),b(g[2],W,B),b(g[3],D,K)}function H(g,f,u){for(let r=0;r<4;r++)R(g[r],f[r],u)}function ee(g,f){const u=s(),r=s(),l=s();L(l,f[2]),b(u,f[0],l),b(r,f[1],l),$(g,r),g[31]^=V(u)<<7}function p(g,f,u){T(g[0],a),T(g[1],c),T(g[2],c),T(g[3],a);for(let r=255;r>=0;--r){const l=u[r/8|0]>>(r&7)&1;H(g,f,l),z(f,g),z(g,g),H(g,f,l)}}function m(g,f){const u=[s(),s(),s(),s()];T(u[0],w),T(u[1],x),T(u[2],c),b(u[3],w,x),p(g,u,f)}function G(g){if(g.length!==n.SEED_LENGTH)throw new Error(`ed25519: seed must be ${n.SEED_LENGTH} bytes`);const f=(0,t.hash)(g);f[0]&=248,f[31]&=127,f[31]|=64;const u=new Uint8Array(32),r=[s(),s(),s(),s()];m(r,f),ee(u,r);const l=new Uint8Array(64);return l.set(g),l.set(u,32),{publicKey:u,secretKey:l}}n.generateKeyPairFromSeed=G;function Q(g){const f=(0,e.randomBytes)(32,g),u=G(f);return(0,i.wipe)(f),u}n.generateKeyPair=Q;function O(g){if(g.length!==n.SECRET_KEY_LENGTH)throw new Error(`ed25519: secret key must be ${n.SECRET_KEY_LENGTH} bytes`);return new Uint8Array(g.subarray(32))}n.extractPublicKeyFromSecretKey=O;const _=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function v(g,f){let u,r,l,C;for(r=63;r>=32;--r){for(u=0,l=r-32,C=r-12;l<C;++l)f[l]+=u-16*f[r]*_[l-(r-32)],u=Math.floor((f[l]+128)/256),f[l]-=u*256;f[l]+=u,f[r]=0}for(u=0,l=0;l<32;l++)f[l]+=u-(f[31]>>4)*_[l],u=f[l]>>8,f[l]&=255;for(l=0;l<32;l++)f[l]-=u*_[l];for(r=0;r<32;r++)f[r+1]+=f[r]>>8,g[r]=f[r]&255}function N(g){const f=new Float64Array(64);for(let u=0;u<64;u++)f[u]=g[u];for(let u=0;u<64;u++)g[u]=0;v(g,f)}function re(g,f){const u=new Float64Array(64),r=[s(),s(),s(),s()],l=(0,t.hash)(g.subarray(0,32));l[0]&=248,l[31]&=127,l[31]|=64;const C=new Uint8Array(64);C.set(l.subarray(32),32);const D=new t.SHA512;D.update(C.subarray(32)),D.update(f);const B=D.digest();D.clean(),N(B),m(r,B),ee(C,r),D.reset(),D.update(C.subarray(0,32)),D.update(g.subarray(32)),D.update(f);const W=D.digest();N(W);for(let K=0;K<32;K++)u[K]=B[K];for(let K=0;K<32;K++)for(let J=0;J<32;J++)u[K+J]+=W[K]*l[J];return v(C.subarray(32),u),C}n.sign=re;function Y(g,f){const u=s(),r=s(),l=s(),C=s(),D=s(),B=s(),W=s();return T(g[2],c),q(g[1],f),P(l,g[1]),b(C,l,h),y(l,l,g[2]),U(C,g[2],C),P(D,C),P(B,D),b(W,B,D),b(u,W,l),b(u,u,C),F(u,u),b(u,u,l),b(u,u,C),b(u,u,C),b(g[0],u,C),P(r,g[0]),b(r,r,C),k(r,l)&&b(g[0],g[0],I),P(r,g[0]),b(r,r,C),k(r,l)?-1:(V(g[0])===f[31]>>7&&y(g[0],a,g[0]),b(g[3],g[0],g[1]),0)}function gt(g,f,u){const r=new Uint8Array(32),l=[s(),s(),s(),s()],C=[s(),s(),s(),s()];if(u.length!==n.SIGNATURE_LENGTH)throw new Error(`ed25519: signature must be ${n.SIGNATURE_LENGTH} bytes`);if(Y(C,g))return!1;const D=new t.SHA512;D.update(u.subarray(0,32)),D.update(g),D.update(f);const B=D.digest();return N(B),p(l,C,B),m(C,u.subarray(32)),z(l,C),ee(r,l),!j(u,r)}n.verify=gt;function ft(g){let f=[s(),s(),s(),s()];if(Y(f,g))throw new Error("Ed25519: invalid public key");let u=s(),r=s(),l=f[1];U(u,c,l),y(r,c,l),L(r,r),b(u,u,r);let C=new Uint8Array(32);return $(C,u),C}n.convertPublicKeyToX25519=ft;function $e(g){const f=(0,t.hash)(g.subarray(0,32));f[0]&=248,f[31]&=127,f[31]|=64;const u=new Uint8Array(f.subarray(0,32));return(0,i.wipe)(f),u}n.convertSecretKeyToX25519=$e})(bi);const Qn="EdDSA",Xn="JWT",js=".",Ks="base64url",Zn="utf8",eo="utf8",to=":",io="did",so="key",Qi="base58btc",ro="z",no="K36",oo=32;function Ht(n){return Bt(mi(wi(n),Zn),Ks)}function Hs(n){const e=mi(no,Qi),t=ro+Bt(Lr([e,n]),Qi);return[io,so,t].join(to)}function ao(n){return Bt(n,Ks)}function co(n){return mi([Ht(n.header),Ht(n.payload)].join(js),eo)}function ho(n){return[Ht(n.header),Ht(n.payload),ao(n.signature)].join(js)}function Xi(n=Os.randomBytes(oo)){return bi.generateKeyPairFromSeed(n)}async function lo(n,e,t,i,s=A.fromMiliseconds(Date.now())){const o={alg:Qn,typ:Xn},a=Hs(i.publicKey),c=s+t,h={iss:a,sub:n,aud:e,iat:s,exp:c},d=co({header:o,payload:h}),w=bi.sign(i.secretKey,d);return ho({header:o,payload:h,signature:w})}const uo="PARSE_ERROR",po="INVALID_REQUEST",go="METHOD_NOT_FOUND",fo="INVALID_PARAMS",Bs="INTERNAL_ERROR",vi="SERVER_ERROR",yo=[-32700,-32600,-32601,-32602,-32603],$t={[uo]:{code:-32700,message:"Parse error"},[po]:{code:-32600,message:"Invalid Request"},[go]:{code:-32601,message:"Method not found"},[fo]:{code:-32602,message:"Invalid params"},[Bs]:{code:-32603,message:"Internal error"},[vi]:{code:-32e3,message:"Server error"}},Gs=vi;function mo(n){return yo.includes(n)}function Zi(n){return Object.keys($t).includes(n)?$t[n]:$t[Gs]}function wo(n){const e=Object.values($t).find(t=>t.code===n);return e||$t[Gs]}function bo(n,e,t){return n.message.includes("getaddrinfo ENOTFOUND")||n.message.includes("connect ECONNREFUSED")?new Error(`Unavailable ${t} RPC url at ${e}`):n}var Ws={},Ze={},es;function vo(){if(es)return Ze;es=1,Object.defineProperty(Ze,"__esModule",{value:!0}),Ze.isBrowserCryptoAvailable=Ze.getSubtleCrypto=Ze.getBrowerCrypto=void 0;function n(){return(globalThis==null?void 0:globalThis.crypto)||(globalThis==null?void 0:globalThis.msCrypto)||{}}Ze.getBrowerCrypto=n;function e(){const i=n();return i.subtle||i.webkitSubtle}Ze.getSubtleCrypto=e;function t(){return!!n()&&!!e()}return Ze.isBrowserCryptoAvailable=t,Ze}var et={},ts;function Eo(){if(ts)return et;ts=1,Object.defineProperty(et,"__esModule",{value:!0}),et.isBrowser=et.isNode=et.isReactNative=void 0;function n(){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"}et.isReactNative=n;function e(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}et.isNode=e;function t(){return!n()&&!e()}return et.isBrowser=t,et}(function(n){Object.defineProperty(n,"__esModule",{value:!0});const e=ht;e.__exportStar(vo(),n),e.__exportStar(Eo(),n)})(Ws);function Ei(n=3){const e=Date.now()*Math.pow(10,n),t=Math.floor(Math.random()*Math.pow(10,n));return e+t}function Js(n=6){return BigInt(Ei(n))}function _t(n,e,t){return{id:t||Ei(),jsonrpc:"2.0",method:n,params:e}}function _i(n,e){return{id:n,jsonrpc:"2.0",result:e}}function xi(n,e,t){return{id:n,jsonrpc:"2.0",error:_o(e,t)}}function _o(n,e){return typeof n>"u"?Zi(Bs):(typeof n=="string"&&(n=Object.assign(Object.assign({},Zi(vi)),{message:n})),typeof e<"u"&&(n.data=e),mo(n.code)&&(n=wo(n.code)),n)}class xo{}class So extends xo{constructor(){super()}}class Io extends So{constructor(e){super()}}const Ro="^wss?:";function Po(n){const e=n.match(new RegExp(/^\w+:/,"gi"));if(!(!e||!e.length))return e[0]}function No(n,e){const t=Po(n);return typeof t>"u"?!1:new RegExp(e).test(t)}function is(n){return No(n,Ro)}function To(n){return new RegExp("wss?://localhost(:d{2,5})?").test(n)}function Ys(n){return typeof n=="object"&&"id"in n&&"jsonrpc"in n&&n.jsonrpc==="2.0"}function Si(n){return Ys(n)&&"method"in n}function Wt(n){return Ys(n)&&(rt(n)||Ke(n))}function rt(n){return"result"in n}function Ke(n){return"error"in n}class Oo extends Io{constructor(e){super(e),this.events=new Je.EventEmitter,this.hasRegisteredEventListeners=!1,this.connection=this.setConnection(e),this.connection.connected&&this.registerEventListeners()}async connect(e=this.connection){await this.open(e)}async disconnect(){await this.close()}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async request(e,t){return this.requestStrict(_t(e.method,e.params||[],e.id||Js().toString()),t)}async requestStrict(e,t){return new Promise(async(i,s)=>{if(!this.connection.connected)try{await this.open()}catch(o){s(o)}this.events.on(`${e.id}`,o=>{Ke(o)?s(o.error):i(o.result)});try{await this.connection.send(e,t)}catch(o){s(o)}})}setConnection(e=this.connection){return e}onPayload(e){this.events.emit("payload",e),Wt(e)?this.events.emit(`${e.id}`,e):this.events.emit("message",{type:e.method,data:e.params})}onClose(e){e&&e.code===3e3&&this.events.emit("error",new Error(`WebSocket connection closed abnormally with code: ${e.code} ${e.reason?`(${e.reason})`:""}`)),this.events.emit("disconnect")}async open(e=this.connection){this.connection===e&&this.connection.connected||(this.connection.connected&&this.close(),typeof e=="string"&&(await this.connection.open(e),e=this.connection),this.connection=this.setConnection(e),await this.connection.open(),this.registerEventListeners(),this.events.emit("connect"))}async close(){await this.connection.close()}registerEventListeners(){this.hasRegisteredEventListeners||(this.connection.on("payload",e=>this.onPayload(e)),this.connection.on("close",e=>this.onClose(e)),this.connection.on("error",e=>this.events.emit("error",e)),this.connection.on("register_error",e=>this.onClose()),this.hasRegisteredEventListeners=!0)}}const Co=()=>typeof WebSocket<"u"?WebSocket:typeof globalThis<"u"&&typeof globalThis.WebSocket<"u"?globalThis.WebSocket:typeof window<"u"&&typeof window.WebSocket<"u"?window.WebSocket:typeof self<"u"&&typeof self.WebSocket<"u"?self.WebSocket:require("ws"),Ao=()=>typeof WebSocket<"u"||typeof globalThis<"u"&&typeof globalThis.WebSocket<"u"||typeof window<"u"&&typeof window.WebSocket<"u"||typeof self<"u"&&typeof self.WebSocket<"u",ss=n=>n.split("?")[0],rs=10,Fo=Co();class Do{constructor(e){if(this.url=e,this.events=new Je.EventEmitter,this.registering=!1,!is(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);this.url=e}get connected(){return typeof this.socket<"u"}get connecting(){return this.registering}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async open(e=this.url){await this.register(e)}async close(){return new Promise((e,t)=>{if(typeof this.socket>"u"){t(new Error("Connection already closed"));return}this.socket.onclose=i=>{this.onClose(i),e()},this.socket.close()})}async send(e,t){typeof this.socket>"u"&&(this.socket=await this.register());try{this.socket.send(wi(e))}catch(i){this.onError(e.id,i)}}register(e=this.url){if(!is(e))throw new Error(`Provided URL is not compatible with WebSocket connection: ${e}`);if(this.registering){const t=this.events.getMaxListeners();return(this.events.listenerCount("register_error")>=t||this.events.listenerCount("open")>=t)&&this.events.setMaxListeners(t+1),new Promise((i,s)=>{this.events.once("register_error",o=>{this.resetMaxListeners(),s(o)}),this.events.once("open",()=>{if(this.resetMaxListeners(),typeof this.socket>"u")return s(new Error("WebSocket connection is missing or invalid"));i(this.socket)})})}return this.url=e,this.registering=!0,new Promise((t,i)=>{const s=Ws.isReactNative()?void 0:{rejectUnauthorized:!To(e)},o=new Fo(e,[],s);Ao()?o.onerror=a=>{const c=a;i(this.emitError(c.error))}:o.on("error",a=>{i(this.emitError(a))}),o.onopen=()=>{this.onOpen(o),t(o)}})}onOpen(e){e.onmessage=t=>this.onPayload(t),e.onclose=t=>this.onClose(t),this.socket=e,this.registering=!1,this.events.emit("open")}onClose(e){this.socket=void 0,this.registering=!1,this.events.emit("close",e)}onPayload(e){if(typeof e.data>"u")return;const t=typeof e.data=="string"?Us(e.data):e.data;this.events.emit("payload",t)}onError(e,t){const i=this.parseError(t),s=i.message||i.toString(),o=xi(e,s);this.events.emit("payload",o)}parseError(e,t=this.url){return bo(e,ss(t),"WS")}resetMaxListeners(){this.events.getMaxListeners()>rs&&this.events.setMaxListeners(rs)}emitError(e){const t=this.parseError(new Error((e==null?void 0:e.message)||`WebSocket connection failed for host: ${ss(this.url)}`));return this.events.emit("register_error",t),t}}function Lo(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var s=0;s<n.length;s++){var o=n.charAt(s),a=o.charCodeAt(0);if(t[a]!==255)throw new TypeError(o+" is ambiguous");t[a]=s}var c=n.length,h=n.charAt(0),d=Math.log(c)/Math.log(256),w=Math.log(256)/Math.log(c);function x(E){if(E instanceof Uint8Array||(ArrayBuffer.isView(E)?E=new Uint8Array(E.buffer,E.byteOffset,E.byteLength):Array.isArray(E)&&(E=Uint8Array.from(E))),!(E instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(E.length===0)return"";for(var R=0,$=0,j=0,k=E.length;j!==k&&E[j]===0;)j++,R++;for(var V=(k-j)*w+1>>>0,q=new Uint8Array(V);j!==k;){for(var U=E[j],y=0,b=V-1;(U!==0||y<$)&&b!==-1;b--,y++)U+=256*q[b]>>>0,q[b]=U%c>>>0,U=U/c>>>0;if(U!==0)throw new Error("Non-zero carry");$=y,j++}for(var P=V-$;P!==V&&q[P]===0;)P++;for(var L=h.repeat(R);P<V;++P)L+=n.charAt(q[P]);return L}function I(E){if(typeof E!="string")throw new TypeError("Expected String");if(E.length===0)return new Uint8Array;var R=0;if(E[R]!==" "){for(var $=0,j=0;E[R]===h;)$++,R++;for(var k=(E.length-R)*d+1>>>0,V=new Uint8Array(k);E[R];){var q=t[E.charCodeAt(R)];if(q===255)return;for(var U=0,y=k-1;(q!==0||U<j)&&y!==-1;y--,U++)q+=c*V[y]>>>0,V[y]=q%256>>>0,q=q/256>>>0;if(q!==0)throw new Error("Non-zero carry");j=U,R++}if(E[R]!==" "){for(var b=k-j;b!==k&&V[b]===0;)b++;for(var P=new Uint8Array($+(k-b)),L=$;b!==k;)P[L++]=V[b++];return P}}}function T(E){var R=I(E);if(R)return R;throw new Error(`Non-${e} character`)}return{encode:x,decodeUnsafe:I,decode:T}}var qo=Lo,$o=qo;const Qs=n=>{if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")},Mo=n=>new TextEncoder().encode(n),zo=n=>new TextDecoder().decode(n);class ko{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Uo{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Xs(this,e)}}class Vo{constructor(e){this.decoders=e}or(e){return Xs(this,e)}decode(e){const t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const Xs=(n,e)=>new Vo({...n.decoders||{[n.prefix]:n},...e.decoders||{[e.prefix]:e}});class jo{constructor(e,t,i,s){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=s,this.encoder=new ko(e,t,i),this.decoder=new Uo(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Jt=({name:n,prefix:e,encode:t,decode:i})=>new jo(n,e,t,i),kt=({prefix:n,name:e,alphabet:t})=>{const{encode:i,decode:s}=$o(t,e);return Jt({prefix:n,name:e,encode:i,decode:o=>Qs(s(o))})},Ko=(n,e,t,i)=>{const s={};for(let w=0;w<e.length;++w)s[e[w]]=w;let o=n.length;for(;n[o-1]==="=";)--o;const a=new Uint8Array(o*t/8|0);let c=0,h=0,d=0;for(let w=0;w<o;++w){const x=s[n[w]];if(x===void 0)throw new SyntaxError(`Non-${i} character`);h=h<<t|x,c+=t,c>=8&&(c-=8,a[d++]=255&h>>c)}if(c>=t||255&h<<8-c)throw new SyntaxError("Unexpected end of data");return a},Ho=(n,e,t)=>{const i=e[e.length-1]==="=",s=(1<<t)-1;let o="",a=0,c=0;for(let h=0;h<n.length;++h)for(c=c<<8|n[h],a+=8;a>t;)a-=t,o+=e[s&c>>a];if(a&&(o+=e[s&c<<t-a]),i)for(;o.length*t&7;)o+="=";return o},ce=({name:n,prefix:e,bitsPerChar:t,alphabet:i})=>Jt({prefix:e,name:n,encode(s){return Ho(s,i,t)},decode(s){return Ko(s,i,t,n)}}),Bo=Jt({prefix:"\0",name:"identity",encode:n=>zo(n),decode:n=>Mo(n)});var Go=Object.freeze({__proto__:null,identity:Bo});const Wo=ce({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var Jo=Object.freeze({__proto__:null,base2:Wo});const Yo=ce({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var Qo=Object.freeze({__proto__:null,base8:Yo});const Xo=kt({prefix:"9",name:"base10",alphabet:"0123456789"});var Zo=Object.freeze({__proto__:null,base10:Xo});const ea=ce({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ta=ce({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var ia=Object.freeze({__proto__:null,base16:ea,base16upper:ta});const sa=ce({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ra=ce({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),na=ce({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),oa=ce({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),aa=ce({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ca=ce({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ha=ce({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),la=ce({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ua=ce({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var da=Object.freeze({__proto__:null,base32:sa,base32upper:ra,base32pad:na,base32padupper:oa,base32hex:aa,base32hexupper:ca,base32hexpad:ha,base32hexpadupper:la,base32z:ua});const pa=kt({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),ga=kt({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var fa=Object.freeze({__proto__:null,base36:pa,base36upper:ga});const ya=kt({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ma=kt({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var wa=Object.freeze({__proto__:null,base58btc:ya,base58flickr:ma});const ba=ce({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),va=ce({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ea=ce({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),_a=ce({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var xa=Object.freeze({__proto__:null,base64:ba,base64pad:va,base64url:Ea,base64urlpad:_a});const Zs=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),Sa=Zs.reduce((n,e,t)=>(n[t]=e,n),[]),Ia=Zs.reduce((n,e,t)=>(n[e.codePointAt(0)]=t,n),[]);function Ra(n){return n.reduce((e,t)=>(e+=Sa[t],e),"")}function Pa(n){const e=[];for(const t of n){const i=Ia[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Na=Jt({prefix:"🚀",name:"base256emoji",encode:Ra,decode:Pa});var Ta=Object.freeze({__proto__:null,base256emoji:Na}),Oa=er,ns=128,Ca=127,Aa=~Ca,Fa=Math.pow(2,31);function er(n,e,t){e=e||[],t=t||0;for(var i=t;n>=Fa;)e[t++]=n&255|ns,n/=128;for(;n&Aa;)e[t++]=n&255|ns,n>>>=7;return e[t]=n|0,er.bytes=t-i+1,e}var Da=pi,La=128,os=127;function pi(n,i){var t=0,i=i||0,s=0,o=i,a,c=n.length;do{if(o>=c)throw pi.bytes=0,new RangeError("Could not decode varint");a=n[o++],t+=s<28?(a&os)<<s:(a&os)*Math.pow(2,s),s+=7}while(a>=La);return pi.bytes=o-i,t}var qa=Math.pow(2,7),$a=Math.pow(2,14),Ma=Math.pow(2,21),za=Math.pow(2,28),ka=Math.pow(2,35),Ua=Math.pow(2,42),Va=Math.pow(2,49),ja=Math.pow(2,56),Ka=Math.pow(2,63),Ha=function(n){return n<qa?1:n<$a?2:n<Ma?3:n<za?4:n<ka?5:n<Ua?6:n<Va?7:n<ja?8:n<Ka?9:10},Ba={encode:Oa,decode:Da,encodingLength:Ha},tr=Ba;const as=(n,e,t=0)=>(tr.encode(n,e,t),e),cs=n=>tr.encodingLength(n),gi=(n,e)=>{const t=e.byteLength,i=cs(n),s=i+cs(t),o=new Uint8Array(s+t);return as(n,o,0),as(t,o,i),o.set(e,s),new Ga(n,t,e,o)};class Ga{constructor(e,t,i,s){this.code=e,this.size=t,this.digest=i,this.bytes=s}}const ir=({name:n,code:e,encode:t})=>new Wa(n,e,t);class Wa{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?gi(this.code,t):t.then(i=>gi(this.code,i))}else throw Error("Unknown type, must be binary type")}}const sr=n=>async e=>new Uint8Array(await crypto.subtle.digest(n,e)),Ja=ir({name:"sha2-256",code:18,encode:sr("SHA-256")}),Ya=ir({name:"sha2-512",code:19,encode:sr("SHA-512")});var Qa=Object.freeze({__proto__:null,sha256:Ja,sha512:Ya});const rr=0,Xa="identity",nr=Qs,Za=n=>gi(rr,nr(n)),ec={code:rr,name:Xa,encode:nr,digest:Za};var tc=Object.freeze({__proto__:null,identity:ec});new TextEncoder,new TextDecoder;const hs={...Go,...Jo,...Qo,...Zo,...ia,...da,...fa,...wa,...xa,...Ta};({...Qa,...tc});function or(n){return globalThis.Buffer!=null?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n}function ic(n=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?or(globalThis.Buffer.allocUnsafe(n)):new Uint8Array(n)}function ar(n,e,t,i){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:i}}}const ls=ar("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),oi=ar("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);const e=ic(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),sc={utf8:ls,"utf-8":ls,hex:hs.base16,latin1:oi,ascii:oi,binary:oi,...hs};function rc(n,e="utf8"){const t=sc[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?or(globalThis.Buffer.from(n,"utf-8")):t.decoder.decode(`${t.prefix}${n}`)}const cr="wc",nc=2,Ii="core",ct=`${cr}@2:${Ii}:`,oc={name:Ii,logger:"error"},ac={database:":memory:"},cc="crypto",us="client_ed25519_seed",hc=A.ONE_DAY,lc="keychain",uc="0.3",dc="messages",pc="0.3",gc=A.SIX_HOURS,fc="publisher",hr="irn",yc="error",lr="wss://relay.walletconnect.com",ds="wss://relay.walletconnect.org",mc="relayer",Pe={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},wc="_subscription",tt={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},bc=A.ONE_SECOND,vc="2.10.4",Ec=1e4,_c="0.3",xc="WALLETCONNECT_CLIENT_ID",Ve={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"},Sc="subscription",Ic="0.3",Rc=A.FIVE_SECONDS*1e3,Pc="pairing",Nc="0.3",Ct={wc_pairingDelete:{req:{ttl:A.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:A.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:A.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:A.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:A.ONE_DAY,prompt:!1,tag:0},res:{ttl:A.ONE_DAY,prompt:!1,tag:0}}},Lt={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},Ge={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},Tc="history",Oc="0.3",Cc="expirer",ke={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ac="0.3",ai="verify-api",vt="https://verify.walletconnect.com",fi="https://verify.walletconnect.org",Fc=[vt,fi];class Dc{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=lc,this.version=uc,this.initialized=!1,this.storagePrefix=ct,this.init=async()=>{if(!this.initialized){const i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}},this.has=i=>(this.isInitialized(),this.keychain.has(i)),this.set=async(i,s)=>{this.isInitialized(),this.keychain.set(i,s),await this.persist()},this.get=i=>{this.isInitialized();const s=this.keychain.get(i);if(typeof s>"u"){const{message:o}=S("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(o)}return s},this.del=async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()},this.core=e,this.logger=M.generateChildLogger(t,this.name)}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Ds(e))}async getKeyChain(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Ls(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Lc{constructor(e,t,i){this.core=e,this.logger=t,this.name=cc,this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=s=>(this.isInitialized(),this.keychain.has(s)),this.getClientId=async()=>{this.isInitialized();const s=await this.getClientSeed(),o=Xi(s);return Hs(o.publicKey)},this.generateKeyPair=()=>{this.isInitialized();const s=Mr();return this.setPrivateKey(s.publicKey,s.privateKey)},this.signJWT=async s=>{this.isInitialized();const o=await this.getClientSeed(),a=Xi(o),c=ui();return await lo(c,s,hc,a)},this.generateSharedKey=(s,o,a)=>{this.isInitialized();const c=this.getPrivateKey(s),h=zr(c,o);return this.setSymKey(h,a)},this.setSymKey=async(s,o)=>{this.isInitialized();const a=o||kr(s);return await this.keychain.set(a,s),a},this.deleteKeyPair=async s=>{this.isInitialized(),await this.keychain.del(s)},this.deleteSymKey=async s=>{this.isInitialized(),await this.keychain.del(s)},this.encode=async(s,o,a)=>{this.isInitialized();const c=Ur(a),h=wi(o);if(Ci(c)){const I=c.senderPublicKey,T=c.receiverPublicKey;s=await this.generateSharedKey(I,T)}const d=this.getSymKey(s),{type:w,senderPublicKey:x}=c;return Vr({type:w,symKey:d,message:h,senderPublicKey:x})},this.decode=async(s,o,a)=>{this.isInitialized();const c=jr(o,a);if(Ci(c)){const h=c.receiverPublicKey,d=c.senderPublicKey;s=await this.generateSharedKey(h,d)}try{const h=this.getSymKey(s),d=Kr({symKey:h,encoded:o});return Us(d)}catch(h){this.logger.error(`Failed to decode message from topic: '${s}', clientId: '${await this.getClientId()}'`),this.logger.error(h)}},this.getPayloadType=s=>{const o=Ai(s);return Hr(o.type)},this.getPayloadSenderPublicKey=s=>{const o=Ai(s);return o.senderPublicKey?Bt(o.senderPublicKey,Br):void 0},this.core=e,this.logger=M.generateChildLogger(t,this.name),this.keychain=i||new Dc(this.core,this.logger)}get context(){return M.getLoggerContext(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(us)}catch{e=ui(),await this.keychain.set(us,e)}return rc(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class qc extends kn{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=dc,this.version=pc,this.initialized=!1,this.storagePrefix=ct,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{const i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}},this.set=async(i,s)=>{this.isInitialized();const o=Et(s);let a=this.messages.get(i);return typeof a>"u"&&(a={}),typeof a[o]<"u"||(a[o]=s,this.messages.set(i,a),await this.persist()),o},this.get=i=>{this.isInitialized();let s=this.messages.get(i);return typeof s>"u"&&(s={}),s},this.has=(i,s)=>{this.isInitialized();const o=this.get(i),a=Et(s);return typeof o[a]<"u"},this.del=async i=>{this.isInitialized(),this.messages.delete(i),await this.persist()},this.logger=M.generateChildLogger(e,this.name),this.core=t}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Ds(e))}async getRelayerMessages(){const e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Ls(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class $c extends Un{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new Je.EventEmitter,this.name=fc,this.queue=new Map,this.publishTimeout=A.toMiliseconds(A.TEN_SECONDS),this.needsTransportRestart=!1,this.publish=async(i,s,o)=>{var a;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:o}});try{const c=(o==null?void 0:o.ttl)||gc,h=di(o),d=(o==null?void 0:o.prompt)||!1,w=(o==null?void 0:o.tag)||0,x=(o==null?void 0:o.id)||Js().toString(),I={topic:i,message:s,opts:{ttl:c,relay:h,prompt:d,tag:w,id:x}},T=setTimeout(()=>this.queue.set(x,I),this.publishTimeout);try{await await Mt(this.rpcPublish(i,s,c,h,d,w,x),this.publishTimeout,"Failed to publish payload, please try again."),this.removeRequestFromQueue(x),this.relayer.events.emit(Pe.publish,I)}catch(E){if(this.logger.debug("Publishing Payload stalled"),this.needsTransportRestart=!0,(a=o==null?void 0:o.internal)!=null&&a.throwOnFailedPublish)throw this.removeRequestFromQueue(x),E;return}finally{clearTimeout(T)}this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:s,opts:o}})}catch(c){throw this.logger.debug("Failed to Publish Payload"),this.logger.error(c),c}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.relayer=e,this.logger=M.generateChildLogger(t,this.name),this.registerEventListeners()}get context(){return M.getLoggerContext(this.logger)}rpcPublish(e,t,i,s,o,a,c){var h,d,w,x;const I={method:Kt(s.protocol).publish,params:{topic:e,message:t,ttl:i,prompt:o,tag:a},id:c};return at((h=I.params)==null?void 0:h.prompt)&&((d=I.params)==null||delete d.prompt),at((w=I.params)==null?void 0:w.tag)&&((x=I.params)==null||delete x.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:I}),this.relayer.request(I)}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{const{topic:t,message:i,opts:s}=e;await this.publish(t,i,s)})}registerEventListeners(){this.relayer.core.heartbeat.on(xt.HEARTBEAT_EVENTS.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(Pe.connection_stalled);return}this.checkQueue()}),this.relayer.on(Pe.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}}class Mc{constructor(){this.map=new Map,this.set=(e,t)=>{const i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;const i=this.get(e);if(!this.exists(e,t))return;const s=i.filter(o=>o!==t);if(!s.length){this.map.delete(e);return}this.map.set(e,s)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}}var zc=Object.defineProperty,kc=Object.defineProperties,Uc=Object.getOwnPropertyDescriptors,ps=Object.getOwnPropertySymbols,Vc=Object.prototype.hasOwnProperty,jc=Object.prototype.propertyIsEnumerable,gs=(n,e,t)=>e in n?zc(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,At=(n,e)=>{for(var t in e||(e={}))Vc.call(e,t)&&gs(n,t,e[t]);if(ps)for(var t of ps(e))jc.call(e,t)&&gs(n,t,e[t]);return n},ci=(n,e)=>kc(n,Uc(e));class Kc extends Kn{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new Mc,this.events=new Je.EventEmitter,this.name=Sc,this.version=Ic,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=ct,this.subscribeTimeout=1e4,this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),this.clientId=await this.relayer.core.crypto.getClientId())},this.subscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}});try{const o=di(s),a={topic:i,relay:o};this.pending.set(i,a);const c=await this.rpcSubscribe(i,o);return this.onSubscribe(c,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:s}}),c}catch(o){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(o),o}},this.unsubscribe=async(i,s)=>{await this.restartToComplete(),this.isInitialized(),typeof(s==null?void 0:s.id)<"u"?await this.unsubscribeById(i,s.id,s):await this.unsubscribeByTopic(i,s)},this.isSubscribed=async i=>this.topics.includes(i)?!0:await new Promise((s,o)=>{const a=new A.Watch;a.start(this.pendingSubscriptionWatchLabel);const c=setInterval(()=>{!this.pending.has(i)&&this.topics.includes(i)&&(clearInterval(c),a.stop(this.pendingSubscriptionWatchLabel),s(!0)),a.elapsed(this.pendingSubscriptionWatchLabel)>=Rc&&(clearInterval(c),a.stop(this.pendingSubscriptionWatchLabel),o(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=M.generateChildLogger(t,this.name),this.clientId=""}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){const i=this.topicMap.get(e);await Promise.all(i.map(async s=>await this.unsubscribeById(e,s,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{const s=di(i);await this.rpcUnsubscribe(e,t,s);const o=Ae("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,o),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(s){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(s),s}}async rpcSubscribe(e,t){const i={method:Kt(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await Mt(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(Pe.connection_stalled)}return Et(e+this.clientId)}async rpcBatchSubscribe(e){if(!e.length)return;const t=e[0].relay,i={method:Kt(t.protocol).batchSubscribe,params:{topics:e.map(s=>s.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{return await await Mt(this.relayer.request(i),this.subscribeTimeout)}catch{this.logger.debug("Outgoing Relay Payload stalled"),this.relayer.events.emit(Pe.connection_stalled)}}rpcUnsubscribe(e,t,i){const s={method:Kt(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s}),this.relayer.request(s)}onSubscribe(e,t){this.setSubscription(e,ci(At({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,At({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.subscriptions.has(e)||(this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t))}addSubscription(e,t){this.subscriptions.set(e,At({},t)),this.topicMap.set(t.topic,e),this.events.emit(Ve.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});const t=this.subscriptions.get(e);if(!t){const{message:i}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});const i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(Ve.deleted,ci(At({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Ve.sync)}async reset(){if(this.cached.length){const e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){const i=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(i)}}this.events.emit(Ve.resubscribed)}async restore(){try{const e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;const t=await this.rpcBatchSubscribe(e);qs(t)&&this.onBatchSubscribe(t.map((i,s)=>ci(At({},e[s]),{id:i})))}async onConnect(){this.restartInProgress||(await this.restart(),this.onEnable())}onDisconnect(){this.onDisable()}async checkPending(){if(!this.initialized||this.relayer.transportExplicitlyClosed)return;const e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e)}registerEventListeners(){this.relayer.core.heartbeat.on(xt.HEARTBEAT_EVENTS.pulse,async()=>{await this.checkPending()}),this.relayer.on(Pe.connect,async()=>{await this.onConnect()}),this.relayer.on(Pe.disconnect,()=>{this.onDisconnect()}),this.events.on(Ve.created,async e=>{const t=Ve.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(Ve.deleted,async e=>{const t=Ve.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){this.restartInProgress&&await new Promise(e=>{const t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}}var Hc=Object.defineProperty,fs=Object.getOwnPropertySymbols,Bc=Object.prototype.hasOwnProperty,Gc=Object.prototype.propertyIsEnumerable,ys=(n,e,t)=>e in n?Hc(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Wc=(n,e)=>{for(var t in e||(e={}))Bc.call(e,t)&&ys(n,t,e[t]);if(fs)for(var t of fs(e))Gc.call(e,t)&&ys(n,t,e[t]);return n};class Jc extends Vn{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new Je.EventEmitter,this.name=mc,this.transportExplicitlyClosed=!1,this.initialized=!1,this.connectionAttemptInProgress=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","socket stalled"],this.hasExperiencedNetworkDisruption=!1,this.request=async t=>{this.logger.debug("Publishing Request Payload");try{return await this.toEstablishConnection(),await this.provider.request(t)}catch(i){throw this.logger.debug("Failed to Publish Request"),this.logger.error(i),i}},this.onPayloadHandler=t=>{this.onProviderPayload(t)},this.onConnectHandler=()=>{this.events.emit(Pe.connect)},this.onDisconnectHandler=()=>{this.onProviderDisconnect()},this.onProviderErrorHandler=t=>{this.logger.error(t),this.events.emit(Pe.error,t),this.logger.info("Fatal socket error received, closing transport"),this.transportClose()},this.registerProviderListeners=()=>{this.provider.on(tt.payload,this.onPayloadHandler),this.provider.on(tt.connect,this.onConnectHandler),this.provider.on(tt.disconnect,this.onDisconnectHandler),this.provider.on(tt.error,this.onProviderErrorHandler)},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?M.generateChildLogger(e.logger,this.name):M.pino(M.getDefaultLoggerOptions({level:e.logger||yc})),this.messages=new qc(this.logger,e.core),this.subscriber=new Kc(this,this.logger),this.publisher=new $c(this,this.logger),this.relayUrl=(e==null?void 0:e.relayUrl)||lr,this.projectId=e.projectId,this.provider={}}async init(){this.logger.trace("Initialized"),this.registerEventListeners(),await this.createProvider(),await Promise.all([this.messages.init(),this.subscriber.init()]);try{await this.transportOpen()}catch{this.logger.warn(`Connection via ${this.relayUrl} failed, attempting to connect via failover domain ${ds}...`),await this.restartTransport(ds)}this.initialized=!0,setTimeout(async()=>{this.subscriber.topics.length===0&&(this.logger.info("No topics subscribed to after init, closing transport"),await this.transportClose(),this.transportExplicitlyClosed=!1)},Ec)}get context(){return M.getLoggerContext(this.logger)}get connected(){return this.provider.connection.connected}get connecting(){return this.provider.connection.connecting}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now()})}async subscribe(e,t){var i;this.isInitialized();let s=((i=this.subscriber.topicMap.get(e))==null?void 0:i[0])||"";if(s)return s;let o;const a=c=>{c.topic===e&&(this.subscriber.off(Ve.created,a),o())};return await Promise.all([new Promise(c=>{o=c,this.subscriber.on(Ve.created,a)}),new Promise(async c=>{s=await this.subscriber.subscribe(e,t),c()})]),s}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportClose(){this.transportExplicitlyClosed=!0,this.hasExperiencedNetworkDisruption&&this.connected?await Mt(this.provider.disconnect(),1e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.connected&&await this.provider.disconnect()}async transportOpen(e){if(this.transportExplicitlyClosed=!1,await this.confirmOnlineStateOrThrow(),!this.connectionAttemptInProgress){e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportClose(),await this.createProvider()),this.connectionAttemptInProgress=!0;try{await Promise.all([new Promise(t=>{if(!this.initialized)return t();this.subscriber.once(Ve.resubscribed,()=>{t()})}),new Promise(async(t,i)=>{try{await Mt(this.provider.connect(),1e4,`Socket stalled when trying to connect to ${this.relayUrl}`)}catch(s){i(s);return}t()})])}catch(t){this.logger.error(t);const i=t;if(!this.isConnectionStalled(i.message))throw t;this.provider.events.emit(tt.disconnect)}finally{this.connectionAttemptInProgress=!1,this.hasExperiencedNetworkDisruption=!1}}}async restartTransport(e){await this.confirmOnlineStateOrThrow(),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.transportClose(),await this.createProvider(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await Fi())throw new Error("No internet connection detected. Please restart your network and try again.")}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();const e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Oo(new Do(Gr({sdkVersion:vc,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0}))),this.registerProviderListeners()}async recordMessageEvent(e){const{topic:t,message:i}=e;await this.messages.set(t,i)}async shouldIgnoreMessageEvent(e){const{topic:t,message:i}=e;if(!i||i.length===0)return this.logger.debug(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isSubscribed(t))return this.logger.debug(`Ignoring message for non-subscribed topic ${t}`),!0;const s=this.messages.has(t,i);return s&&this.logger.debug(`Ignoring duplicate message: ${i}`),s}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Si(e)){if(!e.method.endsWith(wc))return;const t=e.params,{topic:i,message:s,publishedAt:o}=t.data,a={topic:i,message:s,publishedAt:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Wc({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else Wt(e)&&this.events.emit(Pe.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(Pe.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){const t=_i(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(tt.payload,this.onPayloadHandler),this.provider.off(tt.connect,this.onConnectHandler),this.provider.off(tt.disconnect,this.onDisconnectHandler),this.provider.off(tt.error,this.onProviderErrorHandler)}async registerEventListeners(){this.events.on(Pe.connection_stalled,()=>{this.restartTransport().catch(t=>this.logger.error(t))});let e=await Fi();Wr(async t=>{this.initialized&&e!==t&&(e=t,t?await this.restartTransport().catch(i=>this.logger.error(i)):(this.hasExperiencedNetworkDisruption=!0,await this.transportClose().catch(i=>this.logger.error(i))))})}onProviderDisconnect(){this.events.emit(Pe.disconnect),this.attemptToReconnect()}attemptToReconnect(){this.transportExplicitlyClosed||(this.logger.info("attemptToReconnect called. Connecting..."),setTimeout(async()=>{await this.restartTransport().catch(e=>this.logger.error(e))},A.toMiliseconds(bc)))}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectionAttemptInProgress)return await new Promise(e=>{const t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)});await this.restartTransport()}}}var Yc=Object.defineProperty,ms=Object.getOwnPropertySymbols,Qc=Object.prototype.hasOwnProperty,Xc=Object.prototype.propertyIsEnumerable,ws=(n,e,t)=>e in n?Yc(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,bs=(n,e)=>{for(var t in e||(e={}))Qc.call(e,t)&&ws(n,t,e[t]);if(ms)for(var t of ms(e))Xc.call(e,t)&&ws(n,t,e[t]);return n};class Yt extends jn{constructor(e,t,i,s=ct,o=void 0){super(e,t,i,s),this.core=e,this.logger=t,this.name=i,this.map=new Map,this.version=_c,this.cached=[],this.initialized=!1,this.storagePrefix=ct,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!at(a)?this.map.set(this.getKey(a),a):qr(a)?this.map.set(a.id,a):$r(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,c)=>{this.isInitialized(),this.map.has(a)?await this.update(a,c):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:c}),this.map.set(a,c),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(c=>Object.keys(a).every(h=>Tr(c[h],a[h]))):this.values),this.update=async(a,c)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:c});const h=bs(bs({},this.getData(a)),c);this.map.set(a,h),await this.persist()},this.delete=async(a,c)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:c}),this.map.delete(a),await this.persist())},this.logger=M.generateChildLogger(t,this.name),this.storagePrefix=s,this.getKey=o}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){const t=this.map.get(e);if(!t){const{message:i}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{const e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class Zc{constructor(e,t){this.core=e,this.logger=t,this.name=Pc,this.version=Nc,this.events=new Ns,this.initialized=!1,this.storagePrefix=ct,this.ignoredPayloadTypes=[Cs],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]},this.create=async()=>{this.isInitialized();const i=ui(),s=await this.core.crypto.setSymKey(i),o=je(A.FIVE_MINUTES),a={protocol:hr},c={topic:s,expiry:o,relay:a,active:!1},h=Jr({protocol:this.core.protocol,version:this.core.version,topic:s,symKey:i,relay:a});return await this.pairings.set(s,c),await this.core.relayer.subscribe(s),this.core.expirer.set(s,o),{topic:s,uri:h}},this.pair=async i=>{this.isInitialized(),this.isValidPair(i);const{topic:s,symKey:o,relay:a}=Yr(i.uri);let c;if(this.pairings.keys.includes(s)&&(c=this.pairings.get(s),c.active))throw new Error(`Pairing already exists: ${s}. Please try again with a new connection URI.`);this.core.crypto.keychain.has(s)||(await this.core.crypto.setSymKey(o,s),await this.core.relayer.subscribe(s,{relay:a}));const h=je(A.FIVE_MINUTES),d={topic:s,relay:a,expiry:h,active:!1};return await this.pairings.set(s,d),this.core.expirer.set(s,h),i.activatePairing&&await this.activate({topic:s}),this.events.emit(Lt.create,d),d},this.activate=async({topic:i})=>{this.isInitialized();const s=je(A.THIRTY_DAYS);await this.pairings.update(i,{active:!0,expiry:s}),this.core.expirer.set(i,s)},this.ping=async i=>{this.isInitialized(),await this.isValidPing(i);const{topic:s}=i;if(this.pairings.keys.includes(s)){const o=await this.sendRequest(s,"wc_pairingPing",{}),{done:a,resolve:c,reject:h}=mt();this.events.once(ie("pairing_ping",o),({error:d})=>{d?h(d):c()}),await a()}},this.updateExpiry=async({topic:i,expiry:s})=>{this.isInitialized(),await this.pairings.update(i,{expiry:s})},this.updateMetadata=async({topic:i,metadata:s})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:s})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async i=>{this.isInitialized(),await this.isValidDisconnect(i);const{topic:s}=i;this.pairings.keys.includes(s)&&(await this.sendRequest(s,"wc_pairingDelete",Ae("USER_DISCONNECTED")),await this.deletePairing(s))},this.sendRequest=async(i,s,o)=>{const a=_t(s,o),c=await this.core.crypto.encode(i,a),h=Ct[s].req;return this.core.history.set(i,a),this.core.relayer.publish(i,c,h),a.id},this.sendResult=async(i,s,o)=>{const a=_i(i,o),c=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=Ct[h.request.method].res;await this.core.relayer.publish(s,c,d),await this.core.history.resolve(a)},this.sendError=async(i,s,o)=>{const a=xi(i,o),c=await this.core.crypto.encode(s,a),h=await this.core.history.get(s,i),d=Ct[h.request.method]?Ct[h.request.method].res:Ct.unregistered_method.res;await this.core.relayer.publish(s,c,d),await this.core.history.resolve(a)},this.deletePairing=async(i,s)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,Ae("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),s?Promise.resolve():this.core.expirer.del(i)])},this.cleanup=async()=>{const i=this.pairings.getAll().filter(s=>ot(s.expiry));await Promise.all(i.map(s=>this.deletePairing(s.topic)))},this.onRelayEventRequest=i=>{const{topic:s,payload:o}=i;switch(o.method){case"wc_pairingPing":return this.onPairingPingRequest(s,o);case"wc_pairingDelete":return this.onPairingDeleteRequest(s,o);default:return this.onUnknownRpcMethodRequest(s,o)}},this.onRelayEventResponse=async i=>{const{topic:s,payload:o}=i,a=(await this.core.history.get(s,o.id)).request.method;switch(a){case"wc_pairingPing":return this.onPairingPingResponse(s,o);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(i,s)=>{const{id:o}=s;try{this.isValidPing({topic:i}),await this.sendResult(o,i,!0),this.events.emit(Lt.ping,{id:o,topic:i})}catch(a){await this.sendError(o,i,a),this.logger.error(a)}},this.onPairingPingResponse=(i,s)=>{const{id:o}=s;setTimeout(()=>{rt(s)?this.events.emit(ie("pairing_ping",o),{}):Ke(s)&&this.events.emit(ie("pairing_ping",o),{error:s.error})},500)},this.onPairingDeleteRequest=async(i,s)=>{const{id:o}=s;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(Lt.delete,{id:o,topic:i})}catch(a){await this.sendError(o,i,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(i,s)=>{const{id:o,method:a}=s;try{if(this.registeredMethods.includes(a))return;const c=Ae("WC_METHOD_UNSUPPORTED",a);await this.sendError(o,i,c),this.logger.error(c)}catch(c){await this.sendError(o,i,c),this.logger.error(c)}},this.onUnknownRpcMethodResponse=i=>{this.registeredMethods.includes(i)||this.logger.error(Ae("WC_METHOD_UNSUPPORTED",i))},this.isValidPair=i=>{if(!Le(i)){const{message:s}=S("MISSING_OR_INVALID",`pair() params: ${i}`);throw new Error(s)}if(!Qr(i.uri)){const{message:s}=S("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw new Error(s)}},this.isValidPing=async i=>{if(!Le(i)){const{message:o}=S("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(o)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidDisconnect=async i=>{if(!Le(i)){const{message:o}=S("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(o)}const{topic:s}=i;await this.isValidPairingTopic(s)},this.isValidPairingTopic=async i=>{if(!wt(i,!1)){const{message:s}=S("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(s)}if(!this.pairings.keys.includes(i)){const{message:s}=S("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(s)}if(ot(this.pairings.get(i).expiry)){await this.deletePairing(i);const{message:s}=S("EXPIRED",`pairing topic: ${i}`);throw new Error(s)}},this.core=e,this.logger=M.generateChildLogger(t,this.name),this.pairings=new Yt(this.core,this.logger,this.name,this.storagePrefix)}get context(){return M.getLoggerContext(this.logger)}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(Pe.message,async e=>{const{topic:t,message:i}=e;if(!this.pairings.keys.includes(t)||this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))return;const s=await this.core.crypto.decode(t,i);try{Si(s)?(this.core.history.set(t,s),this.onRelayEventRequest({topic:t,payload:s})):Wt(s)&&(await this.core.history.resolve(s),await this.onRelayEventResponse({topic:t,payload:s}),this.core.history.delete(t,s.id))}catch(o){this.logger.error(o)}})}registerExpirerEvents(){this.core.expirer.on(ke.expired,async e=>{const{topic:t}=As(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Lt.expire,{topic:t}))})}}class eh extends zn{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new Je.EventEmitter,this.name=Tc,this.version=Oc,this.cached=[],this.initialized=!1,this.storagePrefix=ct,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(i,s,o)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:s,chainId:o}),this.records.has(s.id))return;const a={id:s.id,topic:i,request:{method:s.method,params:s.params||null},chainId:o,expiry:je(A.THIRTY_DAYS)};this.records.set(a.id,a),this.events.emit(Ge.created,a)},this.resolve=async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;const s=await this.getRecord(i.id);typeof s.response>"u"&&(s.response=Ke(i)?{error:i.error}:{result:i.result},this.records.set(s.id,s),this.events.emit(Ge.updated,s))},this.get=async(i,s)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:s}),await this.getRecord(s)),this.delete=(i,s)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:s}),this.values.forEach(o=>{if(o.topic===i){if(typeof s<"u"&&o.id!==s)return;this.records.delete(o.id),this.events.emit(Ge.deleted,o)}})},this.exists=async(i,s)=>(this.isInitialized(),this.records.has(s)?(await this.getRecord(s)).topic===i:!1),this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=M.generateChildLogger(t,this.name)}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){const e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;const i={topic:t.topic,request:_t(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();const t=this.records.get(e);if(!t){const{message:i}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(Ge.sync)}async restore(){try{const e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(Ge.created,e=>{const t=Ge.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(Ge.updated,e=>{const t=Ge.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.events.on(Ge.deleted,e=>{const t=Ge.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e}),this.persist()}),this.core.heartbeat.on(xt.HEARTBEAT_EVENTS.pulse,()=>{this.cleanup()})}cleanup(){try{this.records.forEach(e=>{A.toMiliseconds(e.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${e.id}`),this.delete(e.topic,e.id))})}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class th extends Hn{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new Je.EventEmitter,this.name=Cc,this.version=Ac,this.cached=[],this.initialized=!1,this.storagePrefix=ct,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=i=>{try{const s=this.formatTarget(i);return typeof this.getExpiration(s)<"u"}catch{return!1}},this.set=(i,s)=>{this.isInitialized();const o=this.formatTarget(i),a={target:o,expiry:s};this.expirations.set(o,a),this.checkExpiry(o,a),this.events.emit(ke.created,{target:o,expiration:a})},this.get=i=>{this.isInitialized();const s=this.formatTarget(i);return this.getExpiration(s)},this.del=i=>{if(this.isInitialized(),this.has(i)){const s=this.formatTarget(i),o=this.getExpiration(s);this.expirations.delete(s),this.events.emit(ke.deleted,{target:s,expiration:o})}},this.on=(i,s)=>{this.events.on(i,s)},this.once=(i,s)=>{this.events.once(i,s)},this.off=(i,s)=>{this.events.off(i,s)},this.removeListener=(i,s)=>{this.events.removeListener(i,s)},this.logger=M.generateChildLogger(t,this.name)}get context(){return M.getLoggerContext(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Xr(e);if(typeof e=="number")return Zr(e);const{message:t}=S("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(ke.sync)}async restore(){try{const e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){const{message:t}=S("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){const t=this.expirations.get(e);if(!t){const{message:i}=S("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}checkExpiry(e,t){const{expiry:i}=t;A.toMiliseconds(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(ke.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(xt.HEARTBEAT_EVENTS.pulse,()=>this.checkExpirations()),this.events.on(ke.created,e=>{const t=ke.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(ke.expired,e=>{const t=ke.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(ke.deleted,e=>{const t=ke.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}}}class ih extends Bn{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.name=ai,this.initialized=!1,this.queue=[],this.verifyDisabled=!1,this.init=async i=>{if(this.verifyDisabled||en()||!Fs())return;const s=this.getVerifyUrl(i==null?void 0:i.verifyUrl);this.verifyUrl!==s&&this.removeIframe(),this.verifyUrl=s;try{await this.createIframe()}catch(o){this.logger.info(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.info(o)}if(!this.initialized){this.removeIframe(),this.verifyUrl=fi;try{await this.createIframe()}catch(o){this.logger.info(`Verify iframe failed to load: ${this.verifyUrl}`),this.logger.info(o),this.verifyDisabled=!0}}},this.register=async i=>{this.initialized?this.sendPost(i.attestationId):(this.addToQueue(i.attestationId),await this.init())},this.resolve=async i=>{if(this.isDevEnv)return"";const s=this.getVerifyUrl(i==null?void 0:i.verifyUrl);let o;try{o=await this.fetchAttestation(i.attestationId,s)}catch(a){this.logger.info(`failed to resolve attestation: ${i.attestationId} from url: ${s}`),this.logger.info(a),o=await this.fetchAttestation(i.attestationId,fi)}return o},this.fetchAttestation=async(i,s)=>{this.logger.info(`resolving attestation: ${i} from url: ${s}`);const o=this.startAbortTimer(A.ONE_SECOND*2),a=await fetch(`${s}/attestation/${i}`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0},this.addToQueue=i=>{this.queue.push(i)},this.processQueue=()=>{this.queue.length!==0&&(this.queue.forEach(i=>this.sendPost(i)),this.queue=[])},this.sendPost=i=>{var s;try{if(!this.iframe)return;(s=this.iframe.contentWindow)==null||s.postMessage(i,"*"),this.logger.info(`postMessage sent: ${i} ${this.verifyUrl}`)}catch{}},this.createIframe=async()=>{let i;const s=o=>{o.data==="verify_ready"&&(this.initialized=!0,this.processQueue(),window.removeEventListener("message",s),i())};await Promise.race([new Promise(o=>{if(document.getElementById(ai))return o();window.addEventListener("message",s);const a=document.createElement("iframe");a.id=ai,a.src=`${this.verifyUrl}/${this.projectId}`,a.style.display="none",document.body.append(a),this.iframe=a,i=o}),new Promise((o,a)=>setTimeout(()=>{window.removeEventListener("message",s),a("verify iframe load timeout")},A.toMiliseconds(A.FIVE_SECONDS)))])},this.removeIframe=()=>{this.iframe&&(this.iframe.remove(),this.iframe=void 0,this.initialized=!1)},this.getVerifyUrl=i=>{let s=i||vt;return Fc.includes(s)||(this.logger.info(`verify url: ${s}, not included in trusted list, assigning default: ${vt}`),s=vt),s},this.logger=M.generateChildLogger(t,this.name),this.verifyUrl=vt,this.abortController=new AbortController,this.isDevEnv=tn()&&{}.IS_VITEST}get context(){return M.getLoggerContext(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),A.toMiliseconds(e))}}var sh=Object.defineProperty,vs=Object.getOwnPropertySymbols,rh=Object.prototype.hasOwnProperty,nh=Object.prototype.propertyIsEnumerable,Es=(n,e,t)=>e in n?sh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,_s=(n,e)=>{for(var t in e||(e={}))rh.call(e,t)&&Es(n,t,e[t]);if(vs)for(var t of vs(e))nh.call(e,t)&&Es(n,t,e[t]);return n};class Ri extends Mn{constructor(e){super(e),this.protocol=cr,this.version=nc,this.name=Ii,this.events=new Je.EventEmitter,this.initialized=!1,this.on=(i,s)=>this.events.on(i,s),this.once=(i,s)=>this.events.once(i,s),this.off=(i,s)=>this.events.off(i,s),this.removeListener=(i,s)=>this.events.removeListener(i,s),this.projectId=e==null?void 0:e.projectId,this.relayUrl=(e==null?void 0:e.relayUrl)||lr,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";const t=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:M.pino(M.getDefaultLoggerOptions({level:(e==null?void 0:e.logger)||oc.logger}));this.logger=M.generateChildLogger(t,this.name),this.heartbeat=new xt.HeartBeat,this.crypto=new Lc(this,this.logger,e==null?void 0:e.keychain),this.history=new eh(this,this.logger),this.expirer=new th(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Tn(_s(_s({},ac),e==null?void 0:e.storageOptions)),this.relayer=new Jc({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Zc(this,this.logger),this.verify=new ih(this.projectId||"",this.logger)}static async init(e){const t=new Ri(e);await t.initialize();const i=await t.crypto.getClientId();return await t.storage.setItem(xc,i),t}get context(){return M.getLoggerContext(this.logger)}async start(){this.initialized||await this.initialize()}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}}const oh=Ri,ur="wc",dr=2,pr="client",Pi=`${ur}@${dr}:${pr}:`,hi={name:pr,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.com"},xs="WALLETCONNECT_DEEPLINK_CHOICE",ah="proposal",ch="Proposal expired",hh="session",jt=A.SEVEN_DAYS,lh="engine",Ft={wc_sessionPropose:{req:{ttl:A.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:A.FIVE_MINUTES,prompt:!1,tag:1101}},wc_sessionSettle:{req:{ttl:A.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:A.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:A.ONE_DAY,prompt:!1,tag:1104},res:{ttl:A.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:A.ONE_DAY,prompt:!1,tag:1106},res:{ttl:A.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:A.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:A.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:A.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:A.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:A.ONE_DAY,prompt:!1,tag:1112},res:{ttl:A.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:A.THIRTY_SECONDS,prompt:!1,tag:1114},res:{ttl:A.THIRTY_SECONDS,prompt:!1,tag:1115}}},li={min:A.FIVE_MINUTES,max:A.SEVEN_DAYS},it={idle:"IDLE",active:"ACTIVE"},uh="request",dh=["wc_sessionPropose","wc_sessionRequest","wc_authRequest"];var ph=Object.defineProperty,gh=Object.defineProperties,fh=Object.getOwnPropertyDescriptors,Ss=Object.getOwnPropertySymbols,yh=Object.prototype.hasOwnProperty,mh=Object.prototype.propertyIsEnumerable,Is=(n,e,t)=>e in n?ph(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,De=(n,e)=>{for(var t in e||(e={}))yh.call(e,t)&&Is(n,t,e[t]);if(Ss)for(var t of Ss(e))mh.call(e,t)&&Is(n,t,e[t]);return n},Dt=(n,e)=>gh(n,fh(e));class wh extends Wn{constructor(e){super(e),this.name=lh,this.events=new Ns,this.initialized=!1,this.ignoredPayloadTypes=[Cs],this.requestQueue={state:it.idle,queue:[]},this.sessionRequestQueue={state:it.idle,queue:[]},this.requestQueueDelay=A.ONE_SECOND,this.init=async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),this.client.core.pairing.register({methods:Object.keys(Ft)}),this.initialized=!0,setTimeout(()=>{this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},A.toMiliseconds(this.requestQueueDelay)))},this.connect=async t=>{await this.isInitialized();const i=Dt(De({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(i);const{pairingTopic:s,requiredNamespaces:o,optionalNamespaces:a,sessionProperties:c,relays:h}=i;let d=s,w,x=!1;if(d&&(x=this.client.core.pairing.pairings.get(d).active),!d||!x){const{topic:V,uri:q}=await this.client.core.pairing.create();d=V,w=q}const I=await this.client.core.crypto.generateKeyPair(),T=De({requiredNamespaces:o,optionalNamespaces:a,relays:h??[{protocol:hr}],proposer:{publicKey:I,metadata:this.client.metadata}},c&&{sessionProperties:c}),{reject:E,resolve:R,done:$}=mt(A.FIVE_MINUTES,ch);if(this.events.once(ie("session_connect"),async({error:V,session:q})=>{if(V)E(V);else if(q){q.self.publicKey=I;const U=Dt(De({},q),{requiredNamespaces:q.requiredNamespaces,optionalNamespaces:q.optionalNamespaces});await this.client.session.set(q.topic,U),await this.setExpiry(q.topic,q.expiry),d&&await this.client.core.pairing.updateMetadata({topic:d,metadata:q.peer.metadata}),R(U)}}),!d){const{message:V}=S("NO_MATCHING_KEY",`connect() pairing topic: ${d}`);throw new Error(V)}const j=await this.sendRequest({topic:d,method:"wc_sessionPropose",params:T}),k=je(A.FIVE_MINUTES);return await this.setProposal(j,De({id:j,expiry:k},T)),{uri:w,approval:$}},this.pair=async t=>(await this.isInitialized(),await this.client.core.pairing.pair(t)),this.approve=async t=>{await this.isInitialized(),await this.isValidApprove(t);const{id:i,relayProtocol:s,namespaces:o,sessionProperties:a}=t,c=this.client.proposal.get(i);let{pairingTopic:h,proposer:d,requiredNamespaces:w,optionalNamespaces:x}=c;h=h||"",Zt(w)||(w=rn(o,"approve()"));const I=await this.client.core.crypto.generateKeyPair(),T=d.publicKey,E=await this.client.core.crypto.generateSharedKey(I,T);h&&i&&(await this.client.core.pairing.updateMetadata({topic:h,metadata:d.metadata}),await this.sendResult({id:i,topic:h,result:{relay:{protocol:s??"irn"},responderPublicKey:I}}),await this.client.proposal.delete(i,Ae("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:h}));const R=De({relay:{protocol:s??"irn"},namespaces:o,requiredNamespaces:w,optionalNamespaces:x,pairingTopic:h,controller:{publicKey:I,metadata:this.client.metadata},expiry:je(jt)},a&&{sessionProperties:a});await this.client.core.relayer.subscribe(E),await this.sendRequest({topic:E,method:"wc_sessionSettle",params:R,throwOnFailedPublish:!0});const $=Dt(De({},R),{topic:E,pairingTopic:h,acknowledged:!1,self:R.controller,peer:{publicKey:d.publicKey,metadata:d.metadata},controller:I});return await this.client.session.set(E,$),await this.setExpiry(E,je(jt)),{topic:E,acknowledged:()=>new Promise(j=>setTimeout(()=>j(this.client.session.get(E)),500))}},this.reject=async t=>{await this.isInitialized(),await this.isValidReject(t);const{id:i,reason:s}=t,{pairingTopic:o}=this.client.proposal.get(i);o&&(await this.sendError(i,o,s),await this.client.proposal.delete(i,Ae("USER_DISCONNECTED")))},this.update=async t=>{await this.isInitialized(),await this.isValidUpdate(t);const{topic:i,namespaces:s}=t,o=await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:s}}),{done:a,resolve:c,reject:h}=mt();return this.events.once(ie("session_update",o),({error:d})=>{d?h(d):c()}),await this.client.session.update(i,{namespaces:s}),{acknowledged:a}},this.extend=async t=>{await this.isInitialized(),await this.isValidExtend(t);const{topic:i}=t,s=await this.sendRequest({topic:i,method:"wc_sessionExtend",params:{}}),{done:o,resolve:a,reject:c}=mt();return this.events.once(ie("session_extend",s),({error:h})=>{h?c(h):a()}),await this.setExpiry(i,je(jt)),{acknowledged:o}},this.request=async t=>{await this.isInitialized(),await this.isValidRequest(t);const{chainId:i,request:s,topic:o,expiry:a}=t,c=Ei(),{done:h,resolve:d,reject:w}=mt(a,"Request expired. Please try again.");return this.events.once(ie("session_request",c),({error:x,result:I})=>{x?w(x):d(I)}),await Promise.all([new Promise(async x=>{await this.sendRequest({clientRpcId:c,topic:o,method:"wc_sessionRequest",params:{request:s,chainId:i},expiry:a,throwOnFailedPublish:!0}).catch(I=>w(I)),this.client.events.emit("session_request_sent",{topic:o,request:s,chainId:i,id:c}),x()}),new Promise(async x=>{const I=await this.client.core.storage.getItem(xs);nn({id:c,topic:o,wcDeepLink:I}),x()}),h()]).then(x=>x[2])},this.respond=async t=>{await this.isInitialized(),await this.isValidRespond(t);const{topic:i,response:s}=t,{id:o}=s;rt(s)?await this.sendResult({id:o,topic:i,result:s.result,throwOnFailedPublish:!0}):Ke(s)&&await this.sendError(o,i,s.error),this.cleanupAfterResponse(t)},this.ping=async t=>{await this.isInitialized(),await this.isValidPing(t);const{topic:i}=t;if(this.client.session.keys.includes(i)){const s=await this.sendRequest({topic:i,method:"wc_sessionPing",params:{}}),{done:o,resolve:a,reject:c}=mt();this.events.once(ie("session_ping",s),({error:h})=>{h?c(h):a()}),await o()}else this.client.core.pairing.pairings.keys.includes(i)&&await this.client.core.pairing.ping({topic:i})},this.emit=async t=>{await this.isInitialized(),await this.isValidEmit(t);const{topic:i,event:s,chainId:o}=t;await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:s,chainId:o}})},this.disconnect=async t=>{await this.isInitialized(),await this.isValidDisconnect(t);const{topic:i}=t;this.client.session.keys.includes(i)?(await this.sendRequest({topic:i,method:"wc_sessionDelete",params:Ae("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession(i)):await this.client.core.pairing.disconnect({topic:i})},this.find=t=>(this.isInitialized(),this.client.session.getAll().filter(i=>on(i,t))),this.getPendingSessionRequests=()=>(this.isInitialized(),this.client.pendingRequest.getAll()),this.cleanupDuplicatePairings=async t=>{if(t.pairingTopic)try{const i=this.client.core.pairing.pairings.get(t.pairingTopic),s=this.client.core.pairing.pairings.getAll().filter(o=>{var a,c;return((a=o.peerMetadata)==null?void 0:a.url)&&((c=o.peerMetadata)==null?void 0:c.url)===t.peer.metadata.url&&o.topic&&o.topic!==i.topic});if(s.length===0)return;this.client.logger.info(`Cleaning up ${s.length} duplicate pairing(s)`),await Promise.all(s.map(o=>this.client.core.pairing.disconnect({topic:o.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}},this.deleteSession=async(t,i)=>{const{self:s}=this.client.session.get(t);await this.client.core.relayer.unsubscribe(t),this.client.session.delete(t,Ae("USER_DISCONNECTED")),this.client.core.crypto.keychain.has(s.publicKey)&&await this.client.core.crypto.deleteKeyPair(s.publicKey),this.client.core.crypto.keychain.has(t)&&await this.client.core.crypto.deleteSymKey(t),i||this.client.core.expirer.del(t),this.client.core.storage.removeItem(xs).catch(o=>this.client.logger.warn(o))},this.deleteProposal=async(t,i)=>{await Promise.all([this.client.proposal.delete(t,Ae("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(t)])},this.deletePendingSessionRequest=async(t,i,s=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,i),s?Promise.resolve():this.client.core.expirer.del(t)]),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(o=>o.id!==t),s&&(this.sessionRequestQueue.state=it.idle)},this.setExpiry=async(t,i)=>{this.client.session.keys.includes(t)&&await this.client.session.update(t,{expiry:i}),this.client.core.expirer.set(t,i)},this.setProposal=async(t,i)=>{await this.client.proposal.set(t,i),this.client.core.expirer.set(t,i.expiry)},this.setPendingSessionRequest=async t=>{const i=Ft.wc_sessionRequest.req.ttl,{id:s,topic:o,params:a,verifyContext:c}=t;await this.client.pendingRequest.set(s,{id:s,topic:o,params:a,verifyContext:c}),i&&this.client.core.expirer.set(s,je(i))},this.sendRequest=async t=>{const{topic:i,method:s,params:o,expiry:a,relayRpcId:c,clientRpcId:h,throwOnFailedPublish:d}=t,w=_t(s,o,h);if(Fs()&&dh.includes(s)){const T=Et(JSON.stringify(w));this.client.core.verify.register({attestationId:T})}const x=await this.client.core.crypto.encode(i,w),I=Ft[s].req;return a&&(I.ttl=a),c&&(I.id=c),this.client.core.history.set(i,w),d?(I.internal=Dt(De({},I.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,x,I)):this.client.core.relayer.publish(i,x,I).catch(T=>this.client.logger.error(T)),w.id},this.sendResult=async t=>{const{id:i,topic:s,result:o,throwOnFailedPublish:a}=t,c=_i(i,o),h=await this.client.core.crypto.encode(s,c),d=await this.client.core.history.get(s,i),w=Ft[d.request.method].res;a?(w.internal=Dt(De({},w.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(s,h,w)):this.client.core.relayer.publish(s,h,w).catch(x=>this.client.logger.error(x)),await this.client.core.history.resolve(c)},this.sendError=async(t,i,s)=>{const o=xi(t,s),a=await this.client.core.crypto.encode(i,o),c=await this.client.core.history.get(i,t),h=Ft[c.request.method].res;this.client.core.relayer.publish(i,a,h),await this.client.core.history.resolve(o)},this.cleanup=async()=>{const t=[],i=[];this.client.session.getAll().forEach(s=>{ot(s.expiry)&&t.push(s.topic)}),this.client.proposal.getAll().forEach(s=>{ot(s.expiry)&&i.push(s.id)}),await Promise.all([...t.map(s=>this.deleteSession(s)),...i.map(s=>this.deleteProposal(s))])},this.onRelayEventRequest=async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()},this.processRequestsQueue=async()=>{if(this.requestQueue.state===it.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=it.active;const t=this.requestQueue.queue.shift();if(t)try{this.processRequest(t),await new Promise(i=>setTimeout(i,300))}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=it.idle},this.processRequest=t=>{const{topic:i,payload:s}=t,o=s.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeRequest(i,s);case"wc_sessionSettle":return this.onSessionSettleRequest(i,s);case"wc_sessionUpdate":return this.onSessionUpdateRequest(i,s);case"wc_sessionExtend":return this.onSessionExtendRequest(i,s);case"wc_sessionPing":return this.onSessionPingRequest(i,s);case"wc_sessionDelete":return this.onSessionDeleteRequest(i,s);case"wc_sessionRequest":return this.onSessionRequest(i,s);case"wc_sessionEvent":return this.onSessionEventRequest(i,s);default:return this.client.logger.info(`Unsupported request method ${o}`)}},this.onRelayEventResponse=async t=>{const{topic:i,payload:s}=t,o=(await this.client.core.history.get(i,s.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,s);case"wc_sessionSettle":return this.onSessionSettleResponse(i,s);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,s);case"wc_sessionExtend":return this.onSessionExtendResponse(i,s);case"wc_sessionPing":return this.onSessionPingResponse(i,s);case"wc_sessionRequest":return this.onSessionRequestResponse(i,s);default:return this.client.logger.info(`Unsupported response method ${o}`)}},this.onRelayEventUnknownPayload=t=>{const{topic:i}=t,{message:s}=S("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(s)},this.onSessionProposeRequest=async(t,i)=>{const{params:s,id:o}=i;try{this.isValidConnect(De({},i.params));const a=je(A.FIVE_MINUTES),c=De({id:o,pairingTopic:t,expiry:a},s);await this.setProposal(o,c);const h=Et(JSON.stringify(i)),d=await this.getVerifyContext(h,c.proposer.metadata);this.client.events.emit("session_proposal",{id:o,params:c,verifyContext:d})}catch(a){await this.sendError(o,t,a),this.client.logger.error(a)}},this.onSessionProposeResponse=async(t,i)=>{const{id:s}=i;if(rt(i)){const{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});const a=this.client.proposal.get(s);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});const c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});const h=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});const d=await this.client.core.crypto.generateSharedKey(c,h);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",sessionTopic:d});const w=await this.client.core.relayer.subscribe(d);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:w}),await this.client.core.pairing.activate({topic:t})}else Ke(i)&&(await this.client.proposal.delete(s,Ae("USER_DISCONNECTED")),this.events.emit(ie("session_connect"),{error:i.error}))},this.onSessionSettleRequest=async(t,i)=>{const{id:s,params:o}=i;try{this.isValidSessionSettleRequest(o);const{relay:a,controller:c,expiry:h,namespaces:d,requiredNamespaces:w,optionalNamespaces:x,sessionProperties:I,pairingTopic:T}=i.params,E=De({topic:t,relay:a,expiry:h,namespaces:d,acknowledged:!0,pairingTopic:T,requiredNamespaces:w,optionalNamespaces:x,controller:c.publicKey,self:{publicKey:"",metadata:this.client.metadata},peer:{publicKey:c.publicKey,metadata:c.metadata}},I&&{sessionProperties:I});await this.sendResult({id:i.id,topic:t,result:!0}),this.events.emit(ie("session_connect"),{session:E}),this.cleanupDuplicatePairings(E)}catch(a){await this.sendError(s,t,a),this.client.logger.error(a)}},this.onSessionSettleResponse=async(t,i)=>{const{id:s}=i;rt(i)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(ie("session_approve",s),{})):Ke(i)&&(await this.client.session.delete(t,Ae("USER_DISCONNECTED")),this.events.emit(ie("session_approve",s),{error:i.error}))},this.onSessionUpdateRequest=async(t,i)=>{const{params:s,id:o}=i;try{const a=`${t}_session_update`,c=Vt.get(a);if(c&&this.isRequestOutOfSync(c,o)){this.client.logger.info(`Discarding out of sync request - ${o}`);return}this.isValidUpdate(De({topic:t},s)),await this.client.session.update(t,{namespaces:s.namespaces}),await this.sendResult({id:o,topic:t,result:!0}),this.client.events.emit("session_update",{id:o,topic:t,params:s}),Vt.set(a,o)}catch(a){await this.sendError(o,t,a),this.client.logger.error(a)}},this.isRequestOutOfSync=(t,i)=>parseInt(i.toString().slice(0,-3))<=parseInt(t.toString().slice(0,-3)),this.onSessionUpdateResponse=(t,i)=>{const{id:s}=i;rt(i)?this.events.emit(ie("session_update",s),{}):Ke(i)&&this.events.emit(ie("session_update",s),{error:i.error})},this.onSessionExtendRequest=async(t,i)=>{const{id:s}=i;try{this.isValidExtend({topic:t}),await this.setExpiry(t,je(jt)),await this.sendResult({id:s,topic:t,result:!0}),this.client.events.emit("session_extend",{id:s,topic:t})}catch(o){await this.sendError(s,t,o),this.client.logger.error(o)}},this.onSessionExtendResponse=(t,i)=>{const{id:s}=i;rt(i)?this.events.emit(ie("session_extend",s),{}):Ke(i)&&this.events.emit(ie("session_extend",s),{error:i.error})},this.onSessionPingRequest=async(t,i)=>{const{id:s}=i;try{this.isValidPing({topic:t}),await this.sendResult({id:s,topic:t,result:!0}),this.client.events.emit("session_ping",{id:s,topic:t})}catch(o){await this.sendError(s,t,o),this.client.logger.error(o)}},this.onSessionPingResponse=(t,i)=>{const{id:s}=i;setTimeout(()=>{rt(i)?this.events.emit(ie("session_ping",s),{}):Ke(i)&&this.events.emit(ie("session_ping",s),{error:i.error})},500)},this.onSessionDeleteRequest=async(t,i)=>{const{id:s}=i;try{this.isValidDisconnect({topic:t,reason:i.params}),await Promise.all([new Promise(o=>{this.client.core.relayer.once(Pe.publish,async()=>{o(await this.deleteSession(t))})}),this.sendResult({id:s,topic:t,result:!0})]),this.client.events.emit("session_delete",{id:s,topic:t})}catch(o){this.client.logger.error(o)}},this.onSessionRequest=async(t,i)=>{const{id:s,params:o}=i;try{this.isValidRequest(De({topic:t},o));const a=Et(JSON.stringify(_t("wc_sessionRequest",o,s))),c=this.client.session.get(t),h=await this.getVerifyContext(a,c.peer.metadata),d={id:s,topic:t,params:o,verifyContext:h};await this.setPendingSessionRequest(d),this.addSessionRequestToSessionRequestQueue(d),this.processSessionRequestQueue()}catch(a){await this.sendError(s,t,a),this.client.logger.error(a)}},this.onSessionRequestResponse=(t,i)=>{const{id:s}=i;rt(i)?this.events.emit(ie("session_request",s),{result:i.result}):Ke(i)&&this.events.emit(ie("session_request",s),{error:i.error})},this.onSessionEventRequest=async(t,i)=>{const{id:s,params:o}=i;try{const a=`${t}_session_event_${o.event.name}`,c=Vt.get(a);if(c&&this.isRequestOutOfSync(c,s)){this.client.logger.info(`Discarding out of sync request - ${s}`);return}this.isValidEmit(De({topic:t},o)),this.client.events.emit("session_event",{id:s,topic:t,params:o}),Vt.set(a,s)}catch(a){await this.sendError(s,t,a),this.client.logger.error(a)}},this.addSessionRequestToSessionRequestQueue=t=>{this.sessionRequestQueue.queue.push(t)},this.cleanupAfterResponse=t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=it.idle,this.processSessionRequestQueue()},A.toMiliseconds(this.requestQueueDelay))},this.processSessionRequestQueue=()=>{if(this.sessionRequestQueue.state===it.active){this.client.logger.info("session request queue is already active.");return}const t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.sessionRequestQueue.state=it.active,this.client.events.emit("session_request",t)}catch(i){this.client.logger.error(i)}},this.onPairingCreated=t=>{if(t.active)return;const i=this.client.proposal.getAll().find(s=>s.pairingTopic===t.topic);i&&this.onSessionProposeRequest(t.topic,_t("wc_sessionPropose",{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer},i.id))},this.isValidConnect=async t=>{if(!Le(t)){const{message:h}=S("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(h)}const{pairingTopic:i,requiredNamespaces:s,optionalNamespaces:o,sessionProperties:a,relays:c}=t;if(at(i)||await this.isValidPairingTopic(i),!an(c,!0)){const{message:h}=S("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(h)}!at(s)&&Zt(s)!==0&&this.validateNamespaces(s,"requiredNamespaces"),!at(o)&&Zt(o)!==0&&this.validateNamespaces(o,"optionalNamespaces"),at(a)||this.validateSessionProps(a,"sessionProperties")},this.validateNamespaces=(t,i)=>{const s=cn(t,"connect()",i);if(s)throw new Error(s.message)},this.isValidApprove=async t=>{if(!Le(t))throw new Error(S("MISSING_OR_INVALID",`approve() params: ${t}`).message);const{id:i,namespaces:s,relayProtocol:o,sessionProperties:a}=t;await this.isValidProposalId(i);const c=this.client.proposal.get(i),h=ei(s,"approve()");if(h)throw new Error(h.message);const d=Di(c.requiredNamespaces,s,"approve()");if(d)throw new Error(d.message);if(!wt(o,!0)){const{message:w}=S("MISSING_OR_INVALID",`approve() relayProtocol: ${o}`);throw new Error(w)}at(a)||this.validateSessionProps(a,"sessionProperties")},this.isValidReject=async t=>{if(!Le(t)){const{message:o}=S("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(o)}const{id:i,reason:s}=t;if(await this.isValidProposalId(i),!hn(s)){const{message:o}=S("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(s)}`);throw new Error(o)}},this.isValidSessionSettleRequest=t=>{if(!Le(t)){const{message:d}=S("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(d)}const{relay:i,controller:s,namespaces:o,expiry:a}=t;if(!ln(i)){const{message:d}=S("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(d)}const c=un(s,"onSessionSettleRequest()");if(c)throw new Error(c.message);const h=ei(o,"onSessionSettleRequest()");if(h)throw new Error(h.message);if(ot(a)){const{message:d}=S("EXPIRED","onSessionSettleRequest()");throw new Error(d)}},this.isValidUpdate=async t=>{if(!Le(t)){const{message:h}=S("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(h)}const{topic:i,namespaces:s}=t;await this.isValidSessionTopic(i);const o=this.client.session.get(i),a=ei(s,"update()");if(a)throw new Error(a.message);const c=Di(o.requiredNamespaces,s,"update()");if(c)throw new Error(c.message)},this.isValidExtend=async t=>{if(!Le(t)){const{message:s}=S("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(s)}const{topic:i}=t;await this.isValidSessionTopic(i)},this.isValidRequest=async t=>{if(!Le(t)){const{message:h}=S("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(h)}const{topic:i,request:s,chainId:o,expiry:a}=t;await this.isValidSessionTopic(i);const{namespaces:c}=this.client.session.get(i);if(!Li(c,o)){const{message:h}=S("MISSING_OR_INVALID",`request() chainId: ${o}`);throw new Error(h)}if(!dn(s)){const{message:h}=S("MISSING_OR_INVALID",`request() ${JSON.stringify(s)}`);throw new Error(h)}if(!pn(c,o,s.method)){const{message:h}=S("MISSING_OR_INVALID",`request() method: ${s.method}`);throw new Error(h)}if(a&&!gn(a,li)){const{message:h}=S("MISSING_OR_INVALID",`request() expiry: ${a}. Expiry must be a number (in seconds) between ${li.min} and ${li.max}`);throw new Error(h)}},this.isValidRespond=async t=>{if(!Le(t)){const{message:o}=S("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(o)}const{topic:i,response:s}=t;if(await this.isValidSessionTopic(i),!fn(s)){const{message:o}=S("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(s)}`);throw new Error(o)}},this.isValidPing=async t=>{if(!Le(t)){const{message:s}=S("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(s)}const{topic:i}=t;await this.isValidSessionOrPairingTopic(i)},this.isValidEmit=async t=>{if(!Le(t)){const{message:c}=S("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(c)}const{topic:i,event:s,chainId:o}=t;await this.isValidSessionTopic(i);const{namespaces:a}=this.client.session.get(i);if(!Li(a,o)){const{message:c}=S("MISSING_OR_INVALID",`emit() chainId: ${o}`);throw new Error(c)}if(!yn(s)){const{message:c}=S("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(s)}`);throw new Error(c)}if(!mn(a,o,s.name)){const{message:c}=S("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(s)}`);throw new Error(c)}},this.isValidDisconnect=async t=>{if(!Le(t)){const{message:s}=S("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(s)}const{topic:i}=t;await this.isValidSessionOrPairingTopic(i)},this.getVerifyContext=async(t,i)=>{const s={verified:{verifyUrl:i.verifyUrl||vt,validation:"UNKNOWN",origin:i.url||""}};try{const o=await this.client.core.verify.resolve({attestationId:t,verifyUrl:i.verifyUrl});o&&(s.verified.origin=o.origin,s.verified.isScam=o.isScam,s.verified.validation=o.origin===new URL(i.url).origin?"VALID":"INVALID")}catch(o){this.client.logger.info(o)}return this.client.logger.info(`Verify context: ${JSON.stringify(s)}`),s},this.validateSessionProps=(t,i)=>{Object.values(t).forEach(s=>{if(!wt(s,!1)){const{message:o}=S("MISSING_OR_INVALID",`${i} must be in Record<string, string> format. Received: ${JSON.stringify(s)}`);throw new Error(o)}})}}async isInitialized(){if(!this.initialized){const{message:e}=S("NOT_INITIALIZED",this.name);throw new Error(e)}await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(Pe.message,async e=>{const{topic:t,message:i}=e;if(this.ignoredPayloadTypes.includes(this.client.core.crypto.getPayloadType(i)))return;const s=await this.client.core.crypto.decode(t,i);try{Si(s)?(this.client.core.history.set(t,s),this.onRelayEventRequest({topic:t,payload:s})):Wt(s)?(await this.client.core.history.resolve(s),await this.onRelayEventResponse({topic:t,payload:s}),this.client.core.history.delete(t,s.id)):this.onRelayEventUnknownPayload({topic:t,payload:s})}catch(o){this.client.logger.error(o)}})}registerExpirerEvents(){this.client.core.expirer.on(ke.expired,async e=>{const{topic:t,id:i}=As(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,S("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession(t,!0),this.client.events.emit("session_expire",{topic:t})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(Lt.create,e=>this.onPairingCreated(e))}isValidPairingTopic(e){if(!wt(e,!1)){const{message:t}=S("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(ot(this.client.core.pairing.pairings.get(e).expiry)){const{message:t}=S("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!wt(e,!1)){const{message:t}=S("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(!this.client.session.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(ot(this.client.session.get(e).expiry)){await this.deleteSession(e);const{message:t}=S("EXPIRED",`session topic: ${e}`);throw new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(wt(e,!1)){const{message:t}=S("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{const{message:t}=S("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!wn(e)){const{message:t}=S("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){const{message:t}=S("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(ot(this.client.proposal.get(e).expiry)){await this.deleteProposal(e);const{message:t}=S("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}}class bh extends Yt{constructor(e,t){super(e,t,ah,Pi),this.core=e,this.logger=t}}class vh extends Yt{constructor(e,t){super(e,t,hh,Pi),this.core=e,this.logger=t}}class Eh extends Yt{constructor(e,t){super(e,t,uh,Pi,i=>i.id),this.core=e,this.logger=t}}class Ni extends Gn{constructor(e){super(e),this.protocol=ur,this.version=dr,this.name=hi.name,this.events=new Je.EventEmitter,this.on=(i,s)=>this.events.on(i,s),this.once=(i,s)=>this.events.once(i,s),this.off=(i,s)=>this.events.off(i,s),this.removeListener=(i,s)=>this.events.removeListener(i,s),this.removeAllListeners=i=>this.events.removeAllListeners(i),this.connect=async i=>{try{return await this.engine.connect(i)}catch(s){throw this.logger.error(s.message),s}},this.pair=async i=>{try{return await this.engine.pair(i)}catch(s){throw this.logger.error(s.message),s}},this.approve=async i=>{try{return await this.engine.approve(i)}catch(s){throw this.logger.error(s.message),s}},this.reject=async i=>{try{return await this.engine.reject(i)}catch(s){throw this.logger.error(s.message),s}},this.update=async i=>{try{return await this.engine.update(i)}catch(s){throw this.logger.error(s.message),s}},this.extend=async i=>{try{return await this.engine.extend(i)}catch(s){throw this.logger.error(s.message),s}},this.request=async i=>{try{return await this.engine.request(i)}catch(s){throw this.logger.error(s.message),s}},this.respond=async i=>{try{return await this.engine.respond(i)}catch(s){throw this.logger.error(s.message),s}},this.ping=async i=>{try{return await this.engine.ping(i)}catch(s){throw this.logger.error(s.message),s}},this.emit=async i=>{try{return await this.engine.emit(i)}catch(s){throw this.logger.error(s.message),s}},this.disconnect=async i=>{try{return await this.engine.disconnect(i)}catch(s){throw this.logger.error(s.message),s}},this.find=i=>{try{return this.engine.find(i)}catch(s){throw this.logger.error(s.message),s}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}},this.name=(e==null?void 0:e.name)||hi.name,this.metadata=(e==null?void 0:e.metadata)||sn();const t=typeof(e==null?void 0:e.logger)<"u"&&typeof(e==null?void 0:e.logger)!="string"?e.logger:M.pino(M.getDefaultLoggerOptions({level:(e==null?void 0:e.logger)||hi.logger}));this.core=(e==null?void 0:e.core)||new oh(e),this.logger=M.generateChildLogger(t,this.name),this.session=new vh(this.core,this.logger),this.proposal=new bh(this.core,this.logger),this.pendingRequest=new Eh(this.core,this.logger),this.engine=new wh(this)}static async init(e){const t=new Ni(e);return await t.initialize(),t}get context(){return M.getLoggerContext(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.engine.init(),this.core.verify.init({verifyUrl:this.metadata.verifyUrl}),this.logger.info("SignClient Initialization Success")}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}}const yi=[{name:"Rainbow",chains:[We.EIP155],logo:"https://images.web3auth.io/login-rainbow.svg",mobile:{native:"rainbow:",universal:"https://rnbwapp.com"},desktop:{native:"",universal:""}},{name:"MetaMask",chains:[We.EIP155],logo:"https://images.web3auth.io/login-metamask.svg",mobile:{native:"metamask:",universal:"https://metamask.app.link"},desktop:{native:"",universal:""}},{name:"Argent",chains:[We.EIP155],logo:"https://images.web3auth.io/login-argent.svg",mobile:{native:"argent://",universal:"https://www.argent.xyz/app"},desktop:{native:"",universal:""}},{name:"Trust Wallet",chains:[We.EIP155],logo:"https://images.web3auth.io/login-trust.svg",mobile:{native:"trust:",universal:"https://link.trustwallet.com"},desktop:{native:"",universal:""}},{name:"Zerion",chains:[We.EIP155],logo:"https://images.web3auth.io/login-zerion.svg",mobile:{native:"zerion://",universal:"https://wallet.zerion.io"},desktop:{native:"",universal:""}}];let gr=function(n){return n.ETH_SEND_TRANSACTION="eth_sendTransaction",n.ETH_SIGN="eth_sign",n.PERSONAL_SIGN="personal_sign",n.ETH_SIGN_TYPED_DATA="eth_signTypedData",n}({}),fr=function(n){return n.ETH_CHAIN_CHANGED="chainChanged",n.ETH_ACCOUNTS_CHANGED="accountsChanged",n}({});const _h=n=>{const{document:e}=n,t=e.querySelector('head > meta[property="og:site_name"]');if(t)return t.content;const i=e.querySelector('head > meta[name="title"]');return i?i.content:e.title&&e.title.length>0?e.title:n.location.hostname};function Rs(n){return new Promise((e,t)=>{try{const i=document.createElement("img");i.onload=()=>e(!0),i.onerror=()=>e(!1),i.src=n}catch(i){t(i)}})}async function xh(n){const{document:e}=n;let t=e.querySelector('head > link[rel="shortcut icon"]');return t&&await Rs(t.href)||(t=Array.from(e.querySelectorAll('head > link[rel="icon"]')).find(i=>!!i.href)||null,t&&await Rs(t.href))?t.href:null}const Sh=async()=>({name:_h(window),icon:await xh(window)}),yr=n=>{const e=[];return n.forEach(t=>{const[i]=t.split(":");e.includes(i)||e.push(i)}),e},mr=n=>{switch(n){case We.EIP155:return Object.values(gr);default:throw new Error(`No default methods for namespace: ${n}`)}},wr=n=>{switch(n){case We.EIP155:return Object.values(fr);default:throw new Error(`No default events for namespace: ${n}`)}},br=n=>{const e=yr(n);return Object.fromEntries(e.map(t=>[t,{methods:mr(t),chains:n.filter(i=>i.startsWith(t)),events:wr(t)}]))},vr=async(n,e,t)=>{if(n===We.EIP155){const i=await Sh(),s={walletConnectInitOptions:{projectId:t,relayUrl:"wss://relay.walletconnect.com",metadata:{name:i.name,description:i.name,url:window.location.origin,icons:[i.icon||""]}}},o=e.map(c=>`${n}:${c}`),a={requiredNamespaces:br(o)};return{adapterSettings:s,loginSettings:a}}throw new Error(`Unsupported chain namespace: ${n}`)},Ps=(n,e,t)=>{var i,s;const o=(t==null?void 0:t.requiredNamespaces)||{},a=`${n}:${e}`;return!o[n].chains||((i=o[n].chains)===null||i===void 0?void 0:i.length)===0?!1:!!((s=o[n].chains)===null||s===void 0?void 0:s.includes(a))};class Ih extends vn{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(e),Be(this,"name",It.WALLET_CONNECT_V2),Be(this,"adapterNamespace",Or.EIP155),Be(this,"currentChainNamespace",We.EIP155),Be(this,"type",Cr.EXTERNAL),Be(this,"adapterOptions",void 0),Be(this,"status",ze.NOT_READY),Be(this,"adapterData",{uri:"",extensionAdapters:yi}),Be(this,"connector",null),Be(this,"activeSession",null),Be(this,"wcProvider",null),this.adapterOptions=Xt({},e)}get connected(){return!!this.activeSession}get provider(){return this.status!==ze.NOT_READY&&this.wcProvider?this.wcProvider:null}set provider(e){throw new Error("Not implemented")}async init(e){var t,i,s;await super.init(),super.checkInitializationRequirements();const o=(t=this.adapterOptions.adapterSettings)===null||t===void 0||(t=t.walletConnectInitOptions)===null||t===void 0?void 0:t.projectId;if(!o)throw Qe.invalidParams("Wallet connect project id is required in wallet connect v2 adapter");const a=await vr((i=this.chainConfig)===null||i===void 0?void 0:i.chainNamespace,[parseInt((s=this.chainConfig)===null||s===void 0?void 0:s.chainId,16)],o);this.adapterOptions.loginSettings||(this.adapterOptions.loginSettings=a.loginSettings),this.adapterOptions.adapterSettings=Ar(a.adapterSettings,this.adapterOptions.adapterSettings);const{adapterSettings:c}=this.adapterOptions;if(this.connector=await Ni.init(c==null?void 0:c.walletConnectInitOptions),this.wcProvider=new qi({config:{chainConfig:this.chainConfig},connector:this.connector}),this.emit(st.READY,It.WALLET_CONNECT_V2),this.status=ze.READY,Xe.debug("initializing wallet connect v2 adapter"),e.autoConnect)if(await this.checkForPersistedSession(),this.connected){this.rehydrated=!0;try{await this.onConnectHandler()}catch(h){Xe.error("wallet auto connect",h),this.emit(st.ERRORED,h)}}else this.status=ze.NOT_READY,this.emit(st.CACHE_CLEAR)}async connect(){if(super.checkConnectionRequirements(),!this.connector)throw Qe.notReady("Wallet adapter is not ready yet");try{return this.connected?(await this.onConnectHandler(),this.provider):(this.status!==ze.CONNECTING&&await this.createNewSession(),this.provider)}catch(e){throw Xe.error("Wallet connect v2 adapter error while connecting",e),this.status=ze.READY,this.rehydrated=!0,this.emit(st.ERRORED,e),e instanceof Fr?e:qt.connectionError(`Failed to login with wallet connect: ${(e==null?void 0:e.message)||""}`)}}async addChain(e){var t;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(super.checkAddChainRequirements(e,i),!Ps(this.currentChainNamespace,parseInt(e.chainId,16),this.adapterOptions.loginSettings))throw Oi.chainIDNotAllowed(`Unsupported chainID: ${e.chainId}`);await((t=this.wcProvider)===null||t===void 0?void 0:t.addChain(e)),this.addChainConfig(e)}async switchChain(e){var t;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(super.checkSwitchChainRequirements(e,i),!Ps(this.currentChainNamespace,parseInt(e.chainId,16),this.adapterOptions.loginSettings))throw Oi.chainIDNotAllowed(`Unsupported chainID: ${e.chainId}`);await((t=this.wcProvider)===null||t===void 0?void 0:t.switchChain({chainId:e.chainId})),this.setAdapterSettings({chainConfig:this.getChainConfig(e.chainId)})}async getUserInfo(){if(!this.connected)throw qt.notConnectedError("Not connected with wallet, Please login/connect first");return{}}async disconnect(){var e,t;let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{cleanup:!1};await super.disconnectSession();const{cleanup:s}=i;if(!this.connector||!this.connected||!((e=this.activeSession)!==null&&e!==void 0&&e.topic))throw qt.notConnectedError("Not connected with wallet");await this.connector.disconnect({topic:(t=this.activeSession)===null||t===void 0?void 0:t.topic,reason:Ae("USER_DISCONNECTED")}),this.rehydrated=!1,s?(this.connector=null,this.status=ze.NOT_READY,this.wcProvider=null):this.status=ze.READY,this.activeSession=null,await super.disconnect()}cleanupPendingPairings(){if(!this.connector)throw Qe.notReady("Wallet adapter is not ready yet");const e=this.connector.pairing.getAll({active:!1});qs(e)&&e.forEach(t=>{this.connector&&this.connector.pairing.delete(t.topic,Ae("USER_DISCONNECTED"))})}async checkForPersistedSession(){if(!this.connector)throw Qe.notReady("Wallet adapter is not ready yet");if(this.connector.session.length){const e=this.connector.session.keys.length-1;this.activeSession=this.connector.session.get(this.connector.session.keys[e])}return this.activeSession}async createNewSession(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{forceNewSession:!1};try{var t,i;if(!this.connector)throw Qe.notReady("Wallet adapter is not ready yet");if(!this.adapterOptions.loginSettings)throw Qe.notReady("login settings are not set yet");if(this.status=ze.CONNECTING,this.emit(st.CONNECTING,{adapter:It.WALLET_CONNECT_V2}),e.forceNewSession&&(t=this.activeSession)!==null&&t!==void 0&&t.topic){var s;await this.connector.disconnect({topic:(s=this.activeSession)===null||s===void 0?void 0:s.topic,reason:Ae("USER_DISCONNECTED")})}Xe.debug("creating new session for web3auth wallet connect");const{uri:o,approval:a}=await this.connector.connect(this.adapterOptions.loginSettings),c=(i=this.adapterOptions)===null||i===void 0||(i=i.adapterSettings)===null||i===void 0?void 0:i.qrcodeModal;if(o)if(c)try{await c.openModal({uri:o}),Xe.debug("EVENT","QR Code Modal closed"),this.status=ze.READY,this.emit(st.READY,It.WALLET_CONNECT_V2)}catch{Xe.error("unable to open qr code modal")}else this.updateAdapterData({uri:o,extensionAdapters:yi});this.connector.events.once("proposal_expire",d=>{Xe.info("proposal expired",d),this.createNewSession({forceNewSession:!0})}),Xe.info("awaiting session approval from wallet");const h=await a();this.activeSession=h,await this.onConnectHandler(),c&&c.closeModal()}catch(o){throw Xe.error("error while creating new wallet connect session",o),this.emit(st.ERRORED,o),o}}async onConnectHandler(){var e;if(!this.connector||!this.wcProvider)throw Qe.notReady("Wallet adapter is not ready yet");if(!this.chainConfig)throw Qe.invalidParams("Chain config is not set");(e=this.adapterOptions.adapterSettings)!==null&&e!==void 0&&e.qrcodeModal&&(this.wcProvider=new qi({config:{chainConfig:this.chainConfig,skipLookupNetwork:!0},connector:this.connector})),await this.wcProvider.setupProvider(this.connector),this.subscribeEvents(),this.cleanupPendingPairings(),this.status=ze.CONNECTED,this.emit(st.CONNECTED,{adapter:It.WALLET_CONNECT_V2,reconnected:this.rehydrated})}subscribeEvents(){if(!this.connector)throw Qe.notReady("Wallet adapter is not ready yet");this.connector.events.on("session_update",e=>{let{topic:t,params:i}=e;if(!this.connector)return;const{namespaces:s}=i,o=this.connector.session.get(t),a=Xt(Xt({},o),{},{namespaces:s});this.activeSession=a}),this.connector.events.on("session_delete",()=>{this.disconnect()})}}const Ah=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_EIP155_METHODS:gr,DEFAULT_EIP_155_EVENTS:fr,WALLET_CONNECT_EXTENSION_ADAPTERS:yi,WalletConnectV2Adapter:Ih,getNamespacesFromChains:yr,getRequiredNamespaces:br,getSupportedEventsByNamespace:wr,getSupportedMethodsByNamespace:mr,getWalletConnectV2Settings:vr},Symbol.toStringTag,{value:"Module"}));export{vn as B,Ih as W,vr as g,Ah as w};
